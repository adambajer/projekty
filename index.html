<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <title>游늶 Facebook Popt치vky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #1254a0;
    }

    body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }

    .main-title {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: bold;
      margin-top: 2rem;
      margin-bottom: 2.5rem;
      color: #222;
      gap: 0.7rem;
    }

    #run-log {
      color: #555;
      position: fixed;

      bottom: 0px;
      z-index: 6;
      font-size: 1.04em;

      display: flex;
      flex-wrap: wrap;
      align-items: center;
      font-size: .99em;
      justify-content: center;
    }

    #run-log div {
      box-shadow: 0 2px 10px #0001;
      padding: 10px; 
      gap: 0.3em;
      background: #ffffff8e;
      border: 1px solid #ddd;
      backdrop-filter: blur(4px);
      z-index: 2000 !important;
    }#run-log div span {
      padding-right: 2px;font-size:1rem;
    }

    #posts {
      max-width: 1800px;
      margin: 0 auto 3.5rem auto;
      padding: 0 2vw;
    }

    .day-row {
      display: grid;
      grid-template-columns: 110px 1fr;
      /* timeline + karty */
      align-items: start;
      min-height: 90px;
    }

    .timeline {
      position: relative;
      width: 110px;
      min-height: 90px;
      display: flex;
      align-items: flex-start;
      height: 100%;

      justify-content: flex-start;
    }

    .timeline-line {
      width: 3px;
      height: 100%;
      background: var(--primary, #1976d2);
      z-index: 0;
    }

    .timeline-dot {
      width: 15px;
      height: 15px;
      background: var(--primary);
      border-radius: 50%;
      transform: translate(-60%, 10px);
      z-index: 1;
    }

    .timeline-date,
    .timeline-dot {
      position: sticky;
      top: 0px;
      z-index: 5;
    }

    .timeline-date {
      transform: translate(0, 10px);

    }

    .day-row {
      position: relative;
      /* nic v칤c nemus칤코 */
    }

    .timeline-date {
      font-size:1rem;
      color: var(--primary, #1976d2);
      font-weight: bold;
      white-space: nowrap;
      z-index: 2;
      background: none;
      border-radius: 0;
    }

    .cards-day {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      /* po캜et sloupc콢 podle 코칤콏ky */
      gap: 0;
      /* 쮂멳n치 mezera */
      padding-left: 0;
    padding-left: 2rem;

    }

    .profil {
       font-size: 1em;    color: var(--primary, #1976d2);

    }

    .card {
      background: #fff;
      padding: 0.78em 0.92em 2.2em 0.92em;
      /* extra m칤sto dole pro tla캜칤tko koment치콏콢 */
      border: 1px solid #eaeaea;
      border-radius: 0;
      margin-bottom: 0;
      min-width: 0;
      max-width: 100%;
      width: auto;
      position: relative;
      box-shadow: none;
    }

    #posts {
      max-width: 1800px;
      margin: 0 auto 3.5rem auto;
      padding: 0;
      /* 콯치dn칠 vnit콏n칤 odsazen칤 */
    }



    .card:hover {
      box-shadow: 0 6px 36px 0 #0002;
    }

    .card-time {
      font-weight: bold;
      font-size: 0.96em;
      color: #666;
    }

    .card-header {
      font-size: 1em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.35em;
      margin-bottom: 0.13rem;
      min-width: 0;
    }

    .profil {}

    .user-link {
      text-decoration: none;
      font-weight: 600;
      margin-right: 1rem;
      max-width: 185px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;       font-size: 1em;
    color: #666;

      color: black;
      vertical-align: middle;
    }

    .user-link[title]:hover {
      text-decoration: underline;
    }

    .date {
      display: none !important;
    }

    .post-link {
      margin-left: auto;
      text-decoration: none;
      display: flex;
      align-items: center;
      font-size: 1.18em;
    }

    .post-link:hover {}

    .card {
      position: relative;
    }

    .card .comment-toggle {
      position: absolute;
      right: 0.7em;
      bottom: 0.7em;
      margin: 0;
    color: #666;
      opacity: 0.8;
      font-size: 1.15em;
      transition: color 0.2s, opacity 0.2s;
      z-index: 2; 

    }

    .card .comment-toggle:hover {
      color: var(--primary);
      opacity: 1;
    }


    .card-body {
      margin: 0.25rem 0 0.7rem 0;
      font-size: 1.07rem;
      color: #1a232e;
      word-break: break-word;
      min-height: 34px;
      flex: 1 1 auto;
      padding: 0;
      /* men코칤 padding textu */
      white-space: pre-line;
    }

    .card-footer,
    .comments-list {
      display: none;
    }

    .card-footer.active,
    .comments-list.active {
      display: flex;
    }

    .card-footer {
      margin-top: auto;
      gap: 0.4rem;
      align-items: center;
      padding-top: 0.6rem;
      border-top: 1px solid #f2f2f2;
    }

    .comment-item {
      padding: 0.23em 0.6em;
      font-size: 0.95em;
      margin-bottom: 2px;
      border-radius: 7px;
    }

    .comment-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.43rem 0.85rem;
      font-size: 1.03rem;
      transition: border 0.2s;
      outline: none;
    }

    .comment-input:focus {
      border: 1.5px solid var(--primary);
    }

    .add-comment-btn {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 0.48rem 1.1rem;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.16s;
    }

    .add-comment-btn:hover {
      background: var(--primary-dark);
    }

    .comments-list {
      margin-top: 0.6rem;
      padding-left: 0.4rem;
      flex-direction: column;
    }

    .comment-item {
      color: #444;
      background: #f8fafc;
      border-radius: 9px;
      margin-bottom: 5px;
      padding: 0.35em 0.8em;
      font-size: 0.98em;
    }

    .comment-item .comment-date {
      color: #aaa;
      font-size: 0.9em;
      margin-left: 0.7em;
    }

    /* ---- zelen칳 den: override ---- */
    .day-row.green,
    .day-row.green .timeline-date,
    .day-row.green .card,
    .day-row.green .user-link,
    .day-row.green .card-time,
    .day-row.green .post-link,
    .day-row.green .comment-toggle {
      --primary: #27b36a;
      --primary-dark: #157144;
    }

    .day-row.green .timeline-dot {
      background: #27b36a !important;
    }

    .day-row.green .timeline-date {
      color: #27b36a !important;
    }

    .day-row.green .card-time {
      color: #27b36a !important;
    }

    .day-row.green .user-link,
    .day-row.green .post-link,
    .day-row.green .comment-toggle {
      color: #27b36a !important;
    }

    @media (max-width: 1050px) {
      .card {
        min-width: 260px;
        max-width: 100%;
      }

      .cards-day {
        gap: 1.1rem;
      }
    }

    @media (max-width: 800px) {
      #posts {
        padding: 0;
      }

      .main-title {
        font-size: 1.45rem;
      }

      .card {
        padding: 1.15rem 0.8rem 1rem 0.9rem;
      }

      .day-row {
        flex-direction: column;
        gap: 0.7rem;
        padding-bottom: 0.7rem;
      }

      .timeline-date {
        text-align: left;
        margin-bottom: 8px;
        position: static !important;
        border-radius: 0;
        background: none;
        box-shadow: none;
      }
    }

    .openinnew {
      color:#666;
      
      font-size: 1rem;;
    }
  </style>
</head>

<body>

  <div id="run-log"></div>
  <div id="posts">Na캜칤t치m...</div>
  <script>
    const FIREBASE_URL = "https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky.json";
    function fetchRunLog() {
      const KEYS = [
        ["started", "Posledn칤 aktualizace", "<span class='material-icons' title='Posledn칤 aktualizace'>schedule</span>"],
        ["duration_sec", "Doba [s]", "<span class='material-icons' title='Doba'>timer</span>"],
        ["total", "Zpracov치no", "<span class='material-icons' title='Zpracov치no'>done_all</span>"],
        ["saved", "Nov칠", "<span class='material-icons' title='Nov칠'>fiber_new</span>"],
        ["dup", "Duplicit", "<span class='material-icons' title='Duplicit'>content_copy</span>"],
        ["offer", "Nab칤dky", "<span class='material-icons' title='Nab칤dky'>local_offer</span>"],
        ["noKey", "Bez kl칤캜e", "<span class='material-icons' title='Bez kl칤캜e'>vpn_key_off</span>"],
        ["noUrl", "Bez URL", "<span class='material-icons' title='Bez URL'>link_off</span>"],
      ];
      fetch("https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/runs.json")
        .then(r => r.json())
        .then(data => {
          if (!data) return;
          let arr = Object.values(data)
            .filter(run => run.started)
            .sort((a, b) => new Date(b.started) - new Date(a.started));
          let run = arr[0];
          if (!run) return;
          let html = `<div>`;
          for (const [key, label, icon] of KEYS) {
            let value = run[key];
            if (key === "started" || key === "finished") {
              value = value ? new Date(value).toLocaleString('cs-CZ') : "";
            }
            if (typeof value === "undefined" || value === null || value === "") continue;
            html += `<span style='display:inline-flex;align-items:center; >
              <span style='opacity:.79;cursor:pointer;' title='${label}'>${icon}</span>
              <span style='font-weight:bold;min-width:2.3em;text-align:right;line-height:1;'>${value}</span>
            </span>`;
          }
          html += `</div>`;
          document.getElementById("run-log").innerHTML = html;
        });
    }
    fetchRunLog();
    setInterval(fetchRunLog, 45000);

    function extractPostDate(text) {
      const months = [
        "ledna", "칰nora", "b콏ezna", "dubna", "kv캩tna", "캜ervna",
        "캜ervence", "srpna", "z치콏칤", "콏칤jna", "listopadu", "prosince"
      ];
      const re = /(\d{1,2})\.\s*(ledna|칰nora|b콏ezna|dubna|kv캩tna|캜ervna|캜ervence|srpna|z치콏칤|콏칤jna|listopadu|prosince)\s+v?e?\s+(\d{1,2}):(\d{2})/i;
      const match = text.match(re);
      if (!match) return null;
      const day = parseInt(match[1]);
      const month = months.indexOf(match[2].toLowerCase());
      const hour = parseInt(match[3]);
      const minute = parseInt(match[4]);
      if (month === -1) return null;
      const year = (new Date()).getFullYear();
      return new Date(year, month, day, hour, minute, 0, 0);
    }

    function extractCleanText(text) {
      // Odstran칤 "? 22. 캜ervence v 12:32" nebo podobn칳 za캜치tek, p콏칤padn캩 i "? "
      return text.replace(/^[?]?\s*\d{1,2}\.\s*(ledna|칰nora|b콏ezna|dubna|kv캩tna|캜ervna|캜ervence|srpna|z치콏칤|콏칤jna|listopadu|prosince)\s+v?e?\s+\d{1,2}:\d{2}\s*/i, '').trim();
    }

    function extractOnlyTime(date) {
      if (!date) return "";
      return date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
    }

    function fetchComments(postId, cb) {
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`)
        .then(resp => resp.json())
        .then(comments => cb(comments))
        .catch(() => cb(null));
    }

    function addComment(postId, text, cb) {
      const commentObj = {
        text,
        time: new Date().toISOString()
      };
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(commentObj)
      }).then(() => cb && cb());
    }

    fetch(FIREBASE_URL)
      .then(resp => resp.json())
      .then(data => renderPosts(data))
      .catch(() => {
        document.getElementById('posts').innerHTML = '<div style="color:#f55;font-weight:bold">Chyba p콏i na캜칤t치n칤 dat</div>';
      });

    function renderPosts(data) {
      const container = document.getElementById('posts');
      if (!data) {
        container.innerHTML = '<div style="color:#999">콯치dn칠 p콏칤sp캩vky...</div>';
        return;
      }
      const timelineColors = [
        '#1976d2', '#e96458', '#27b36a', '#e4a600', '#9562e6'
      ];
      const items = Object.entries(data)
        .map(([id, post]) => ({ ...post, _id: id }))
        .map(post => {
          let dt = extractPostDate(post.text || "");
          post._dateObj = dt;
          post._dateStr = dt
            ? dt.toLocaleDateString('cs-CZ', { year: 'numeric', month: '2-digit', day: '2-digit' })
            : 'Nezn치m칠 datum';
          return post;
        })
        .sort((a, b) => {
          if (!a._dateObj && !b._dateObj) return 0;
          if (!a._dateObj) return 1;
          if (!b._dateObj) return -1;
          return b._dateObj - a._dateObj;
        });

      let days = {};
      for (const post of items) {
        const key = post._dateStr;
        if (!days[key]) days[key] = [];
        days[key].push(post);
      }
      let html = '';
      let colorIdx = 0;

      for (const day of Object.keys(days)) {
        const color = timelineColors[colorIdx % timelineColors.length];

        // Timeline: 캜치ra + jedna velk치 te캜ka + datum vedle
        let timelineHtml = `<div class="timeline" style="--primary:${color};">
      <div class="timeline-line"></div>
      <div class="timeline-dot"></div>
      <span class="timeline-date">${day}</span>
    </div>`;

        let cardsHtml = `<div class="cards-day">`;
        for (const post of days[day]) {
          let realDate = post._dateObj;
          let showTime = extractOnlyTime(realDate);
          const commentsId = "comments_" + post._id;
          cardsHtml += `
        <div class="card" id="post_${post._id}">
          <div class="card-header">
            <div class="card-time">${showTime}</div>
            <span class="material-icons profil" title="Profil">person</span>
            ${post.userUrl
              ? `<a href="${post.userUrl}" target="_blank" class="user-link" title="${post.author || "Nezn치m칳"}">${post.author || "Nezn치m칳"}</a>`
              : `<span class="user-link" style="color:#aaa;pointer-events:none;" title="${post.author || "Nezn치m칳"}">${post.author || "Nezn치m칳"}</span>`
            }
            <span class="material-icons comment-toggle" title="P콏idat koment치콏">chat_bubble_outline</span>
            <a href="${post.url}" target="_blank" class="post-link" title="Otev콏칤t p콏칤sp캩vek">
              <span class="material-icons openinnew">open_in_new</span>
            </a>
          </div>
          <div class="card-body">${extractCleanText(post.text || "")}</div>
          <div class="comments-list" id="${commentsId}">
            <span style="color:#bbb;">Na캜칤t치m koment치콏e...</span>
          </div>
          <div class="card-footer">
            <input type="text" placeholder="Koment치콏..." class="comment-input" id="input_${post._id}">
            <button class="add-comment-btn" id="btn_${post._id}" disabled>Odeslat</button>
          </div>
        </div>
      `;
        }
        cardsHtml += '</div>';

        html += `
      <div class="day-row" style="--primary:${color};--primary-dark:${color};">
        ${timelineHtml}
        ${cardsHtml}
      </div>
    `;
        colorIdx++;
      }

      container.innerHTML = html;

      // --- ZBYTEK TV칄HO K칍DU NA KOMENT츼콎E ---
      for (const day of Object.keys(days)) {
        for (const post of days[day]) {
          const commentsId = "comments_" + post._id;
          fetchComments(post._id, (comments) => {
            const el = document.getElementById(commentsId);
            if (!comments) {
              el.innerHTML = '<span style="color:#bbb;">(콯치dn칠 koment치콏e)</span>';
              return;
            }
            el.innerHTML = Object.values(comments).map(c => `
          <div class="comment-item">
            ${c.text}
            <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
          </div>
        `).join('');
          });

          setTimeout(() => {
            const card = document.getElementById(`post_${post._id}`);
            const input = card.querySelector(`.comment-input`);
            const btn = card.querySelector(`.add-comment-btn`);
            const footer = card.querySelector(`.card-footer`);
            const commentsDiv = card.querySelector(`.comments-list`);
            const toggle = card.querySelector(`.comment-toggle`);
            toggle.addEventListener('click', () => {
              footer.classList.toggle('active');
              commentsDiv.classList.toggle('active');
              if (footer.classList.contains('active')) input.focus();
            });
            input.addEventListener('input', () => {
              btn.disabled = !input.value.trim();
            });
            btn.addEventListener('click', () => {
              if (!input.value.trim()) return;
              btn.disabled = true;
              addComment(post._id, input.value.trim(), () => {
                input.value = "";
                btn.disabled = false;
                fetchComments(post._id, (comments) => {
                  const el = card.querySelector(`.comments-list`);
                  if (!comments) {
                    el.innerHTML = '<span style="color:#bbb;">(콯치dn칠 koment치콏e)</span>';
                    return;
                  }
                  el.innerHTML = Object.values(comments).map(c => `
                <div class="comment-item">
                  ${c.text}
                  <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                </div>
              `).join('');
                });
              });
            });
          }, 10);
        }
      }
    }

  </script>
</body>

</html>
