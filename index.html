<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <title>📋 Facebook Poptávky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #1254a0;
    }

    body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    .main-title {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: bold;
      margin-top: 2rem;
      margin-bottom: 2.5rem;
      color: #222;
      gap: 0.7rem;
    }

    #run-log {
      color: #555;
      position: fixed;

      bottom: 0px;
      z-index: 6;
      font-size: 1.04em;

      display: flex;
      flex-wrap: wrap;
      align-items: center;
      font-size: .99em;
      justify-content: center;
    }

    #run-log div {
      box-shadow: 0 2px 10px #0001;
      padding: 10px;
      gap: 0.3em;
      background: #ffffff8e;
      border: 1px solid #ddd;
      backdrop-filter: blur(4px);
      z-index: 2000 !important;
    }

    #run-log div span {
      padding-right: 2px;
      font-size: 1rem;
    }

    #posts {
      max-width: 1800px;
      margin: 0 auto 3.5rem auto;
      padding: 0 2vw;
    }

    .day-row {
      display: grid;
      grid-template-columns: 15px 1fr;
      /* timeline + karty */
      align-items: start;
      min-height: 90px;
    }

    .timeline {
      position: relative;
      width: 30px;
      min-height: 90px;
      display: flex;
      align-items: flex-start;
      height: 100%;

      justify-content: flex-start;
    }

    .timeline-line {
      width: 3px;
      height: 100%;
      background: var(--primary, #1976d2);
      z-index: 0;
    }

    .timeline-dot {
      width: 15px;
      height: 30px;
      background: var(--primary);
      transform: translate(-55%, 0px);
      z-index: 1;
    }

    .timeline-date,
    .timeline-dot {
      position: sticky;
      top: 0px;
      left: 0px;
      z-index: 5;
    }

    .timeline-date {
      transform: translate(10px, 0px);
      display: inline-block;
      background-color: white;
      padding: 5px;
    }

    .day-row {
      position: relative;
      margin-top: 5px
        /* nic víc nemusíš */
    }

    .timeline-date {
      font-size: 1rem;
      color: var(--primary, #1976d2);
      font-weight: bold;
      white-space: nowrap;
      z-index: 2;
    }

    .card {
      display: block;
      break-inside: avoid;
      padding: 1rem;
      /* border: 1px solid #ccc;  <-- SMAŽ! */
      box-shadow: 0 0 0 1px #ccc;
      background: #fff;
      margin-bottom: 0rem;
      /* Pro jistotu, aby se neklepaly */
    }

    .cards-day {
      display: block;
      column-count: 4;
      column-gap: 0rem;
      /* Tohle určuje mezeru mezi kartami */
      margin-top: 0rem;
      padding-bottom: 2rem;
      /* Pro jistotu, aby se neklepaly */

    }



    .profil {
      font-size: 1em;
      color: var(--primary, #1976d2);

    }


    #posts {
      max-width: 1800px;
      margin: 0 auto 3.5rem auto;
      padding: 0;
      /* Žádné vnitřní odsazení */
    }



    .card:hover {
      box-shadow: 0 6px 36px 0 #0002;
    }

    .card-time {
      font-weight: bold;
      font-size: 0.96em;
      color: #000;
    }

    .card-header {
      font-size: 1em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.35em;
      margin-bottom: 0.13rem;
      min-width: 0;
    }

    .profil {}

    .user-link {
      text-decoration: none;
      font-weight: 600;
      margin-right: 1rem;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
      font-size: 1em;
      color: #000;

      color: black;
      vertical-align: middle;
    }

    .user-link[title]:hover {
      text-decoration: underline;
    }

    .date {
      display: none !important;
    }

    .post-link {
      margin-left: auto;
      text-decoration: none;
      display: flex;
      align-items: center;
      font-size: 1.18em;
    }

    .post-link:hover {}

    .card {
      position: relative;
    }

    .card .comment-toggle {
      position: absolute;
      right: 0.7em;
      bottom: 0.7em;
      margin: 0;
      color: #000;
      opacity: 0.8;
      font-size: 1.15em;
      transition: color 0.2s, opacity 0.2s;
      z-index: 2;

    }

    .card .comment-toggle:hover {
      color: var(--primary);
      opacity: 1;
    }


    .card-body {
      margin: 0.25rem 0 0.7rem 0;
      font-size: 1.07rem;
      color: #1a232e;
      word-break: break-word;
      min-height: 34px;
      flex: 1 1 auto;
      padding: 0;
      /* menší padding textu */
      white-space: pre-line;
    }

    .card-footer,
    .comments-list {
      display: none;
    }

    .card-footer.active,
    .comments-list.active {
      display: flex;
    }

    .card-footer {
      margin-top: auto;
      gap: 0.4rem;
      align-items: center;
      padding-top: 0.6rem;
      border-top: 1px solid #f2f2f2;
    }

    .comment-item {
      padding: 0.23em 0.6em;
      font-size: 0.95em;
      margin-bottom: 2px;
      border-radius: 7px;
    }

    .comment-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.43rem 0.85rem;
      font-size: 1.03rem;
      transition: border 0.2s;
      outline: none;
    }

    .comment-input:focus {
      border: 1.5px solid var(--primary);
    }

    .add-comment-btn {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 0.48rem 1.1rem;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.16s;
    }

    .add-comment-btn:hover {
      background: var(--primary-dark);
    }

    .comments-list {
      margin-top: 0.6rem;
      padding-left: 0.4rem;
      flex-direction: column;
    }

    .comment-item {
      color: #444;
      background: #f8fafc;
      border-radius: 9px;
      margin-bottom: 5px;
      padding: 0.35em 0.8em;
      font-size: 0.98em;
    }

    .comment-item .comment-date {
      color: #aaa;
      font-size: 0.9em;
      margin-left: 0.7em;
    }

    @media (max-width: 1050px) {
      .card {
        min-width: 260px;
        max-width: 100%;
      }

      .cards-day {
        gap: 1.1rem;
      }
    }

    @media (max-width: 800px) {
      #posts {
        padding: 0;
      }

      .main-title {
        font-size: 1.45rem;
      }

      .card {
        padding: 1.15rem 0.8rem 1rem 0.9rem;
      }

      .day-row {
        flex-direction: column;
        gap: 0.7rem;
        padding-bottom: 0.7rem;
        margin-bottom: 1rem;
      }

      .timeline-date {
        text-align: left;
        margin-bottom: 8px;
        position: static !important;
        border-radius: 0;
        background: none;
        box-shadow: none;
      }
    }

    .openinnew {
      color: #000;

      font-size: 1rem;
      ;
    }

    .filter-btn {
      font-size: 1.04em;
      padding: 0.42em 1.5em;
      border-radius: 1.5em;
      border: 1px solid #d1d7e2;
      background: #e3f1ff;
      color: #144e7a;
      font-weight: 600;
      cursor: pointer;
      margin-right: 0.7em;
      transition: background 0.13s, color 0.13s, border 0.13s;
    }

    .filter-btn:last-child {
      margin-right: 0;
    }

    .filter-btn:hover {
      background: #b9e2ff;
      color: #17497a;
      border-color: #1976d2;
    }

    .custom-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(60, 70, 100, 0.17);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 2.6em 2.9em 2.2em 2.9em;
      border-radius: 26px;
      max-width: 900px;
      width: 94vw;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 16px 48px 0 #0004;
      position: relative;
      min-width: 300px;
    }

    .modal-title {
      font-size: 1.37em;
      font-weight: 700;
      margin-bottom: 1.6em;
      letter-spacing: .02em;
    }

    .close-modal {
      position: absolute;
      right: 22px;
      top: 18px;
      background: none;
      border: none;
      font-size: 2em;
      opacity: .4;
      cursor: pointer;
      transition: opacity .14s;
    }

    .close-modal:hover {
      opacity: .7;
    }

    .chips-box {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7em 0.45em;
      /* větší mezery, první je řádek, druhá sloupec */
      margin-top: 0.3em;
    }

    .kw-chip,
    .ex-chip {
      display: inline-block;
      padding: 0.37em 1.3em;
      font-size: 1.08em;
      border-radius: 1.5em;
      background: #e3f1ff;
      color: #144e7a;
      font-weight: 500;
      border: 1px solid #bcdfff;
      margin-bottom: 0;
      user-select: all;
      transition: background 0.14s, color 0.14s, border 0.14s;
    }

    .ex-chip {
      background: #ffe3e3;
      color: #7a1414;
      border: 1px solid #ffd4d4;
    }

    .kw-chip:hover,
    .ex-chip:hover {
      background: #b9e2ff;
      color: #144e7a;
    }

    .ex-chip:hover {
      background: #ffd4d4;
      color: #7a1414;
    }

    @media (max-width: 700px) {
      .modal-content {
        padding: 1.6em 0.8em 1.2em 0.8em;
      }

      .chips-box {
        gap: 0.48em 0.15em;
      }

      .kw-chip,
      .ex-chip {
        padding: 0.2em 0.75em;
        font-size: 1em;
      }
    }

    .nav-tabs {
      display: flex;
      border-bottom: 2.5px solid #e4e8f0;
      background: #f9fbfe;
      padding: 0 0.6em;
      border-radius: 1.1em 1.1em 0 0;
      box-shadow: 0 2px 10px #0001;
      margin-bottom: 1.4em;
      gap: 0.3em;
    }

    .nav-tabs .nav-item {
      list-style: none;
    }

    .nav-tabs .nav-link {
      display: inline-block;
      color: #1976d2;
      font-weight: 600;
      font-size: 1.07em;
      padding: 0.69em 2.2em 0.5em 2.2em;
      background: none;
      border: none;
      border-radius: 1em 1em 0 0;
      border-bottom: 2.5px solid transparent;
      transition:
        color 0.15s,
        background 0.18s,
        border-bottom 0.16s;
      cursor: pointer;
      margin-right: 0.3em;
      outline: none;
      box-shadow: none;
      text-decoration: none;
      position: relative;
      top: 2px;
    }

    .nav-tabs .nav-link:hover,
    .nav-tabs .nav-link:focus {
      background: #e9f2fb;
      color: #1560a6;
    }

    .nav-tabs .nav-link.active {
      color: #1254a0;
      background: #fff;
      border-bottom: 2.5px solid #1976d2;
      box-shadow: 0 7px 22px 0 #1976d219;
      z-index: 2;
    }

    @media (max-width: 700px) {
      .nav-tabs .nav-link {
        padding: 0.55em 1.05em 0.35em 1.05em;
        font-size: 0.98em;
      }
    }
  </style>
</head>

<body>
  <div class="container" style="margin-top:2rem;margin-bottom:1.3rem;">
    <ul class="nav nav-tabs" id="postsTab" style="font-size:1.1em;">
      <li class="nav-item">
        <a class="nav-link active" data-branch="poptavky" href="#">Poptávky</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-branch="nabidky" href="#">Nabídky</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-branch="jine" href="#">Ostatní</a>
      </li>
      <li class="nav-item"> <button id="show-keywords-btn" class="filter-btn"><span class="material-icons"
            title="Doba">done_all</span> Klíčová slova</button>

      </li>
      <li class="nav-item"> <button id="show-excluded-btn" class="filter-btn"><span class="material-icons"
            title="Doba">local_offer</span> Vyloučené fráze</button>

      </li>
    </ul>
  </div>
  <!-- Modal pro klíčová slova -->
  <div id="keywords-modal" class="custom-modal">
    <div class="modal-content">
      <button class="close-modal" id="close-keywords-modal" title="Zavřít">✕</button>
      <div class="modal-title">Klíčová slova</div>
      <div id="keywords-box" class="chips-box"></div>
    </div>
  </div>
  <!-- Modal pro vyloučené fráze -->
  <div id="excluded-modal" class="custom-modal">
    <div class="modal-content">
      <button class="close-modal" id="close-excluded-modal" title="Zavřít">✕</button>
      <div class="modal-title">Vyloučené fráze</div>
      <div id="excluded-box" class="chips-box"></div>
    </div>
  </div>


  <div id="run-log"></div>
  <div id="posts">Načítám...</div>
  <script>function showModal(id, fetchFn) {
      document.getElementById(id).style.display = "flex";
      if (fetchFn) fetchFn();
    }
    function hideModal(id) {
      document.getElementById(id).style.display = "none";
    }
    // Klíčová slova
    document.getElementById("show-keywords-btn").onclick = () =>
      showModal("keywords-modal", renderKeywords);
    document.getElementById("close-keywords-modal").onclick = () =>
      hideModal("keywords-modal");
    // Vyloučené fráze
    document.getElementById("show-excluded-btn").onclick = () =>
      showModal("excluded-modal", renderExcluded);
    document.getElementById("close-excluded-modal").onclick = () =>
      hideModal("excluded-modal");
    // Zavírání esc a klik vedle modalu
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        hideModal("keywords-modal");
        hideModal("excluded-modal");
      }
    });
    document.querySelectorAll('.custom-modal').forEach(modal => {
      modal.addEventListener('click', e => {
        if (e.target === modal) hideModal(modal.id);
      });
    });

    // Načítání dat
    function renderKeywords() {
      fetch("https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/keywords.json")
        .then(resp => resp.json())
        .then(data => {
          const box = document.getElementById("keywords-box");
          if (!Array.isArray(data)) { box.innerHTML = "<em>Žádná klíčová slova</em>"; return; }
          box.innerHTML = data.map(kw =>
            `<span class="kw-chip">${kw}</span>`
          ).join(' ');
        });
    }
    function renderExcluded() {
      fetch("https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/excluded.json")
        .then(resp => resp.json())
        .then(data => {
          const box = document.getElementById("excluded-box");
          if (!Array.isArray(data)) { box.innerHTML = "<em>Žádné vyloučené fráze</em>"; return; }
          box.innerHTML = data.map(ex =>
            `<span class="ex-chip">${ex}</span>`
          ).join(' ');
        });
    }


    const FIREBASE_URL = "https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky.json";
    let CURRENT_BRANCH = "poptavky";

    function switchTab(branch) {
      CURRENT_BRANCH = branch;
      const FIREBASE_URL = `https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/${branch}.json`;
      document.getElementById('posts').innerHTML = "Načítám...";
      fetch(FIREBASE_URL)
        .then(resp => resp.json())
        .then(data => renderPosts(data))
        .catch(() => {
          document.getElementById('posts').innerHTML = '<div style="color:#f55;font-weight:bold">Chyba při načítání dat</div>';
        });
    }

    // Aktivace tabů
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("#postsTab .nav-link").forEach(tab => {
        tab.addEventListener("click", function (e) {
          e.preventDefault();
          document.querySelectorAll("#postsTab .nav-link").forEach(t => t.classList.remove("active"));
          this.classList.add("active");
          switchTab(this.dataset.branch);
        });
      });
    });

    function fetchRunLog() {
      const KEYS = [
        ["started", "Poslední aktualizace", "<span class='material-icons' title='Poslední aktualizace'>schedule</span>"],
        ["duration_sec", "Doba [s]", "<span class='material-icons' title='Doba'>timer</span>"],
        ["total", "Zpracováno", "<span class='material-icons' title='Zpracováno'>done_all</span>"],
        ["saved", "Nové", "<span class='material-icons' title='Nové'>fiber_new</span>"],
        ["dup", "Duplicit", "<span class='material-icons' title='Duplicit'>content_copy</span>"],
        ["offer", "Nabídky", "<span class='material-icons' title='Nabídky'>local_offer</span>"],
        ["noKey", "Bez klíče", "<span class='material-icons' title='Bez klíče'>vpn_key_off</span>"],
        ["noUrl", "Bez URL", "<span class='material-icons' title='Bez URL'>link_off</span>"],
      ];
      fetch("https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/runs.json")
        .then(r => r.json())
        .then(data => {
          if (!data) return;
          let arr = Object.values(data)
            .filter(run => run.started)
            .sort((a, b) => new Date(b.started) - new Date(a.started));
          let run = arr[0];
          if (!run) return;
          let html = `<div>`;
          for (const [key, label, icon] of KEYS) {
            let value = run[key];
            if (key === "started" || key === "finished") {
              value = value ? new Date(value).toLocaleString('cs-CZ') : "";
            }
            if (typeof value === "undefined" || value === null || value === "") continue;
            html += `<span style='display:inline-flex;align-items:center; >
              <span style='opacity:.79;cursor:pointer;' title='${label}'>${icon}</span>
              <span style='font-weight:bold;min-width:2.3em;text-align:right;line-height:1;'>${value}</span>
            </span>`;
          }
          html += `</div>`;
          document.getElementById("run-log").innerHTML = html;
        });
    }
    fetchRunLog();
    setInterval(fetchRunLog, 45000);

    function extractPostDate(text) {
      const months = [
        "ledna", "února", "března", "dubna", "května", "června",
        "července", "srpna", "září", "října", "listopadu", "prosince"
      ];
      const re = /(\d{1,2})\.\s*(ledna|února|března|dubna|května|června|července|srpna|září|října|listopadu|prosince)\s+v?e?\s+(\d{1,2}):(\d{2})/i;
      const match = text.match(re);
      if (!match) return null;
      const day = parseInt(match[1]);
      const month = months.indexOf(match[2].toLowerCase());
      const hour = parseInt(match[3]);
      const minute = parseInt(match[4]);
      if (month === -1) return null;
      const year = (new Date()).getFullYear();
      return new Date(year, month, day, hour, minute, 0, 0);
    }

    function extractCleanText(text) {
      // Odstraní "? 22. července v 12:32" nebo podobný začátek, případně i "? "
      return text.replace(/^[?]?\s*\d{1,2}\.\s*(ledna|února|března|dubna|května|června|července|srpna|září|října|listopadu|prosince)\s+v?e?\s+\d{1,2}:\d{2}\s*/i, '').trim();
    }

    function extractOnlyTime(date) {
      if (!date) return "";
      return date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
    }

    function fetchComments(postId, cb) {
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`)
        .then(resp => resp.json())
        .then(comments => cb(comments))
        .catch(() => cb(null));
    }

    function addComment(postId, text, cb) {
      const commentObj = {
        text,
        time: new Date().toISOString()
      };
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(commentObj)
      }).then(() => cb && cb());
    }

    switchTab("poptavky");


    function renderPosts(data) {
      const container = document.getElementById('posts');
      if (!data) {
        container.innerHTML = '<div style="color:#999">Žádné příspěvky...</div>';
        return;
      }
      const timelineColors = [
        '#1976d2', '#e96458', '#27b36a', '#e4a600', '#9562e6'
      ];
      const items = Object.entries(data)
        .map(([id, post]) => ({ ...post, _id: id }))
        .map(post => {
          let dt = extractPostDate(post.text || "");
          post._dateObj = dt;
          post._dateStr = dt
            ? dt.toLocaleDateString('cs-CZ', { year: 'numeric', month: '2-digit', day: '2-digit' })
            : 'Neznámé datum';
          return post;
        })
        .sort((a, b) => {
          if (!a._dateObj && !b._dateObj) return 0;
          if (!a._dateObj) return 1;
          if (!b._dateObj) return -1;
          return b._dateObj - a._dateObj;
        });

      let days = {};
      for (const post of items) {
        const key = post._dateStr;
        if (!days[key]) days[key] = [];
        days[key].push(post);
      }
      let html = '';
      let colorIdx = 0;

      for (const day of Object.keys(days)) {
        const color = timelineColors[colorIdx % timelineColors.length];

        // Timeline: čára + jedna velká tečka + datum vedle
        let timelineHtml = `<div class="timeline" style="--primary:${color};">
      <div class="timeline-line"></div>
      <div class="timeline-dot"></div>
    </div>`;

        let cardsHtml = `<div class="cards-day">    `;
        for (const post of days[day]) {
          let realDate = post._dateObj;
          let showTime = extractOnlyTime(realDate);
          const commentsId = "comments_" + post._id;
          cardsHtml += `
          
        <div class="card" id="post_${post._id}">
          <div class="card-header">
            <div class="card-time">${showTime}</div>
            <span class="material-icons profil" title="Profil">person</span>
            ${post.userUrl
              ? `<a href="${post.userUrl}" target="_blank" class="user-link" title="${post.author || "Neznámý"}">${post.author || "Neznámý"}</a>`
              : `<span class="user-link" style="color:#aaa;pointer-events:none;" title="${post.author || "Neznámý"}">${post.author || "Neznámý"}</span>`
            }
            <span class="material-icons comment-toggle" title="Přidat komentář">chat_bubble_outline</span>
            <a href="${post.url}" target="_blank" class="post-link" title="Otevřít příspěvek">
              <span class="material-icons openinnew">open_in_new</span>
            </a>
          </div>
          <div class="card-body">${extractCleanText(post.text || "")}</div>
          <div class="comments-list" id="${commentsId}">
            <span style="color:#bbb;">Načítám komentáře...</span>
          </div>
          <div class="card-footer">
            <input type="text" placeholder="Komentář..." class="comment-input" id="input_${post._id}">
            <button class="add-comment-btn" id="btn_${post._id}" disabled>Odeslat</button>
          </div>
        </div>
      `;
        }
        cardsHtml += '</div>';

        html += ` <span class="timeline-date    "  style="--primary:${color};--primary-dark:${color};">${day}</span> 
      <div class="day-row" style="--primary:${color};--primary-dark:${color};">
        
        ${timelineHtml}
        ${cardsHtml}
      </div>
    `;
        colorIdx++;
      }

      container.innerHTML = html;

      // --- ZBYTEK TVÉHO KÓDU NA KOMENTÁŘE ---
      for (const day of Object.keys(days)) {
        for (const post of days[day]) {
          const commentsId = "comments_" + post._id;
          fetchComments(post._id, (comments) => {
            const el = document.getElementById(commentsId);
            if (!comments) {
              el.innerHTML = '<span style="color:#bbb;">(Žádné komentáře)</span>';
              return;
            }
            el.innerHTML = Object.values(comments).map(c => `
          <div class="comment-item">
            ${c.text}
            <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
          </div>
        `).join('');
          });

          setTimeout(() => {
            const card = document.getElementById(`post_${post._id}`);
            const input = card.querySelector(`.comment-input`);
            const btn = card.querySelector(`.add-comment-btn`);
            const footer = card.querySelector(`.card-footer`);
            const commentsDiv = card.querySelector(`.comments-list`);
            const toggle = card.querySelector(`.comment-toggle`);
            toggle.addEventListener('click', () => {
              footer.classList.toggle('active');
              commentsDiv.classList.toggle('active');
              if (footer.classList.contains('active')) input.focus();
            });
            input.addEventListener('input', () => {
              btn.disabled = !input.value.trim();
            });
            btn.addEventListener('click', () => {
              if (!input.value.trim()) return;
              btn.disabled = true;
              addComment(post._id, input.value.trim(), () => {
                input.value = "";
                btn.disabled = false;
                fetchComments(post._id, (comments) => {
                  const el = card.querySelector(`.comments-list`);
                  if (!comments) {
                    el.innerHTML = '<span style="color:#bbb;">(Žádné komentáře)</span>';
                    return;
                  }
                  el.innerHTML = Object.values(comments).map(c => `
                <div class="comment-item">
                  ${c.text}
                  <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                </div>
              `).join('');
                });
              });
            });
          }, 10);
        }
      }
    }

  </script>
</body>

</html>
