<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>üìã Facebook Popt√°vky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
:root {
  --primary: #1976d2;
  --primary-dark: #1254a0;
}
body { background: #f5f6fa; font-family: 'Roboto', 'Segoe UI', Arial, sans-serif; margin: 0; }
.main-title { display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; margin-top: 2rem; margin-bottom: 2.5rem; color: #222; gap: 0.7rem;}
#run-log { margin: 0 auto 2.2rem auto;  color: #555; font-size: 1.04em; background: #fff; border-radius: 14px; box-shadow: 0 2px 10px #0001; padding: 1.1em 1.7em 1.2em 1.4em;}
#posts { max-width: 1800px; margin: 0 auto 3.5rem auto; padding: 0 2vw; }
.day-row {
  display: grid;
  grid-template-columns: 170px 1fr;
  align-items: start;
  margin-bottom: 3.2rem;
  margin-top: 2.7rem;
  border-bottom: 1.2px dashed #e7e7ef;
  padding-bottom: 1.4rem;
  column-gap: 2.2rem;
}
.timeline-date {
  text-align: right;
  font-weight: bold;
  font-size: 1.17em;
  color: var(--primary);
  letter-spacing: .5px;
  padding-top: 3px;
  padding-right: 10px;
  display: flex;
  align-items: flex-start;
  gap: 0.8em;
  min-width: 0;
  white-space: nowrap;
  background: linear-gradient(90deg, #f5f6fa 96%, #fff0 100%);
  z-index: 3;
  position: sticky;
  left: 0;
  top: 85px;
  box-shadow: 8px 0 8px -8px #e7e7ef70;
  border-radius: 12px 0 0 12px;
  min-height: 38px;
  transition: background 0.3s, color 0.3s;
}
.timeline-date.today {
  background: linear-gradient(90deg, #e3f1fd 96%, #fff0 100%);
  color: #da2638;
}
.timeline-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
  margin-right: 5px;
}
.cards-day {
  display: flex;
  flex-wrap: wrap;
  gap: 2rem;
  align-items: flex-start;
  min-width: 0;
}
.card {
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 4px 24px 0 #0001;
  padding: 1.4rem 1.6rem 1.2rem 1.6rem;
  display: flex;
  flex-direction: column;
  min-width: 370px;
  max-width: 450px;
  transition: box-shadow 0.18s;
  position: relative;
  overflow: hidden;
}
.card:hover { box-shadow: 0 6px 36px 0 #0002; }

.card-time {
  width: 100%;
  display: block;
  font-weight: bold;
  font-size: 1.18em;
  letter-spacing: 1.2px;
  color: var(--primary);
  background: #f5fafe;
  padding: 0.16em 0 0.26em 0;
  margin-bottom: 0.7em;
  border-bottom: 1px solid #e7e7ef;
  text-align: left;
}
.card-header {
  font-size: 1.13rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  margin-bottom: 0.3rem;
  gap: 0.7em;
  flex-wrap: nowrap;
  min-width: 0;
}
.user-link {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
  margin-right: 1rem;
  max-width: 185px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: inline-block;
  vertical-align: middle;
}
.user-link[title]:hover { text-decoration: underline; }
.date { display: none !important; }
.post-link { margin-left: auto; color: var(--primary); text-decoration: none; display: flex; align-items: center; font-size: 1.18em;}
.post-link:hover { color: var(--primary-dark);}
.comment-toggle {
  color: #babdc2;
  cursor: pointer;
  margin-left: 0.5em;
  font-size: 1.2em;
  transition: color 0.2s;
}
.cards-day .comment-toggle { color: var(--primary); opacity: .68; }
.cards-day .comment-toggle:hover { color: var(--primary-dark); }
.card-body { margin: 0.6rem 0 1.1rem 0; font-size: 1.12rem; color: #1a232e; word-break: break-word; min-height: 50px; flex: 1 1 auto; white-space: pre-line; }
.card-footer, .comments-list { display: none; }
.card-footer.active, .comments-list.active { display: flex; }
.card-footer {
  margin-top: auto;
  gap: 0.4rem;
  align-items: center;
  padding-top: 0.6rem;
  border-top: 1px solid #f2f2f2;
}
.comment-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 0.43rem 0.85rem; font-size: 1.03rem; transition: border 0.2s; outline: none;}
.comment-input:focus { border: 1.5px solid var(--primary); }
.add-comment-btn { border: none; background: var(--primary); color: #fff; padding: 0.48rem 1.1rem; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: background 0.16s;}
.add-comment-btn:hover { background: var(--primary-dark);}
.comments-list { margin-top: 0.6rem; padding-left: 0.4rem; flex-direction: column; }
.comment-item { color: #444; background: #f8fafc; border-radius: 9px; margin-bottom: 5px; padding: 0.35em 0.8em; font-size: 0.98em; }
.comment-item .comment-date { color: #aaa; font-size: 0.9em; margin-left: 0.7em;}
/* ---- zelen√Ω den: override ---- */
.day-row.green, .day-row.green .timeline-date, .day-row.green .card, .day-row.green .user-link, .day-row.green .card-time, .day-row.green .post-link, .day-row.green .comment-toggle {
  --primary: #27b36a;
  --primary-dark: #157144;
}
.day-row.green .timeline-dot { background: #27b36a !important; }
.day-row.green .timeline-date { color: #27b36a !important; }
.day-row.green .card-time { color: #27b36a !important; }
.day-row.green .user-link, .day-row.green .post-link, .day-row.green .comment-toggle { color: #27b36a !important; }
@media (max-width: 1050px) {
  .card { min-width: 260px; max-width: 100%; }
  .cards-day { gap: 1.1rem; }
}
@media (max-width: 800px) {
  #posts { padding: 0; }
  .main-title { font-size: 1.45rem; }
  .card { padding: 1.15rem 0.8rem 1rem 0.9rem; }
  .day-row { flex-direction: column; gap: 0.7rem; padding-bottom: 0.7rem; }
  .timeline-date { text-align: left; margin-bottom: 8px; position: static !important; border-radius: 0; background: none; box-shadow:none;}
}
  </style>
</head>
<body>
  <div class="main-title">
    <span class="material-icons" style="font-size:2.5rem; color:#e96458;">edit_note</span>
    Facebook Popt√°vky
  </div>
  <div id="run-log"></div>
  <div id="posts">Naƒç√≠t√°m...</div>
  <script>
    const FIREBASE_URL = "https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky.json";
    function fetchRunLog() {
      const KEYS = [
        ["started", "Posledn√≠ aktualizace", "<span class='material-icons' title='Posledn√≠ aktualizace'>schedule</span>"],
        ["finished", "Konec", "<span class='material-icons' title='Konec'>hourglass_bottom</span>"],
        ["duration_sec", "Doba [s]", "<span class='material-icons' title='Doba'>timer</span>"],
        ["total", "Zpracov√°no", "<span class='material-icons' title='Zpracov√°no'>done_all</span>"],
        ["saved", "Nov√©", "<span class='material-icons' title='Nov√©'>fiber_new</span>"],
        ["dup", "Duplicit", "<span class='material-icons' title='Duplicit'>content_copy</span>"],
        ["offer", "Nab√≠dky", "<span class='material-icons' title='Nab√≠dky'>local_offer</span>"],
        ["noKey", "Bez kl√≠ƒçe", "<span class='material-icons' title='Bez kl√≠ƒçe'>vpn_key_off</span>"],
        ["noUrl", "Bez URL", "<span class='material-icons' title='Bez URL'>link_off</span>"],
        ["note", "Pozn√°mka", "<span class='material-icons' title='Pozn√°mka'>sticky_note_2</span>"]
      ];
      fetch("https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/runs.json")
        .then(r => r.json())
        .then(data => {
          if (!data) return;
          let arr = Object.values(data)
            .filter(run => run.started)
            .sort((a, b) => new Date(b.started) - new Date(a.started));
          let run = arr[0];
          if (!run) return;
          let html = `<div style='display:flex;flex-wrap:wrap;align-items:center;gap:1.7em;font-size:.99em;background:#fff;padding:.65em 1.3em;border-radius:1em;box-shadow:0 2px 14px #0001;justify-content:center;'>`;
          for (const [key, label, icon] of KEYS) {
            let value = run[key];
            if (key === "started" || key === "finished") {
              value = value ? new Date(value).toLocaleString('cs-CZ') : "";
            }
            if (typeof value === "undefined" || value === null || value === "") continue;
            html += `<span style='display:inline-flex;align-items:center;gap:0.24em;min-width:0.8em;'>
              <span style='opacity:.79;cursor:pointer;' title='${label}'>${icon}</span>
              <span style='font-weight:bold;min-width:2.3em;text-align:right;line-height:1;'>${value}</span>
            </span>`;
          }
          html += `</div>`;
          document.getElementById("run-log").innerHTML = html;
        });
    }
    fetchRunLog();
    setInterval(fetchRunLog, 45000);

    function extractPostDate(text) {
      const months = [
        "ledna","√∫nora","b≈ôezna","dubna","kvƒõtna","ƒçervna",
        "ƒçervence","srpna","z√°≈ô√≠","≈ô√≠jna","listopadu","prosince"
      ];
      const re = /(\d{1,2})\.\s*(ledna|√∫nora|b≈ôezna|dubna|kvƒõtna|ƒçervna|ƒçervence|srpna|z√°≈ô√≠|≈ô√≠jna|listopadu|prosince)\s+v?e?\s+(\d{1,2}):(\d{2})/i;
      const match = text.match(re);
      if (!match) return null;
      const day = parseInt(match[1]);
      const month = months.indexOf(match[2].toLowerCase());
      const hour = parseInt(match[3]);
      const minute = parseInt(match[4]);
      if (month === -1) return null;
      const year = (new Date()).getFullYear();
      return new Date(year, month, day, hour, minute, 0, 0);
    }

    function extractCleanText(text) {
      // Odstran√≠ "? 22. ƒçervence v 12:32" nebo podobn√Ω zaƒç√°tek, p≈ô√≠padnƒõ i "? "
      return text.replace(/^[?]?\s*\d{1,2}\.\s*(ledna|√∫nora|b≈ôezna|dubna|kvƒõtna|ƒçervna|ƒçervence|srpna|z√°≈ô√≠|≈ô√≠jna|listopadu|prosince)\s+v?e?\s+\d{1,2}:\d{2}\s*/i, '').trim();
    }

    function extractOnlyTime(date) {
      if (!date) return "";
      return date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
    }

    function fetchComments(postId, cb) {
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`)
        .then(resp => resp.json())
        .then(comments => cb(comments))
        .catch(() => cb(null));
    }

    function addComment(postId, text, cb) {
      const commentObj = {
        text,
        time: new Date().toISOString()
      };
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(commentObj)
      }).then(() => cb && cb());
    }

    fetch(FIREBASE_URL)
      .then(resp => resp.json())
      .then(data => renderPosts(data))
      .catch(() => {
        document.getElementById('posts').innerHTML = '<div style="color:#f55;font-weight:bold">Chyba p≈ôi naƒç√≠t√°n√≠ dat</div>';
      });

    function renderPosts(data) {
      const container = document.getElementById('posts');
      if (!data) {
        container.innerHTML = '<div style="color:#999">≈Ω√°dn√© p≈ô√≠spƒõvky...</div>';
        return;
      }

      const timelineColors = ['#1976d2', '#e96458', '#27b36a', '#e4a600', '#9562e6'];
      const greenDays = [2]; // indexy dn≈Ø (ve timelineColors) kter√© jsou zelen√© ‚Äì tj. 2 => #27b36a

      const items = Object.entries(data)
        .map(([id, post]) => ({...post, _id: id}))
        .map(post => {
          let dt = extractPostDate(post.text || "");
          post._dateObj = dt;
          post._dateStr = dt
            ? dt.toLocaleDateString('cs-CZ', { year: 'numeric', month: '2-digit', day: '2-digit' })
            : 'Nezn√°m√© datum';
          return post;
        })
        .sort((a, b) => {
          if (!a._dateObj && !b._dateObj) return 0;
          if (!a._dateObj) return 1;
          if (!b._dateObj) return -1;
          return b._dateObj - a._dateObj;
        });

      let days = {};
      for (const post of items) {
        const key = post._dateStr;
        if (!days[key]) days[key] = [];
        days[key].push(post);
      }

      let html = '';
      let colorIdx = 0;
      for (const day of Object.keys(days)) {
        const color = timelineColors[colorIdx % timelineColors.length];
        const isGreen = color === '#27b36a';
        html += `<div class="day-row${isGreen ? ' green' : ''}">
          <div class="timeline-date"><span class="timeline-dot" style="background:${color}"></span>${day}</div>
          <div class="cards-day">`;
        for (const post of days[day]) {
          let realDate = post._dateObj;
          let showTime = extractOnlyTime(realDate);
          const commentsId = "comments_" + post._id;
          html += `
            <div class="card" id="post_${post._id}">
              <div class="card-time">${showTime}</div>
              <div class="card-header">
                <span class="material-icons" title="Profil">person</span>
                ${
                  post.userUrl
                    ? `<a href="${post.userUrl}" target="_blank" class="user-link" title="${post.author || "Nezn√°m√Ω"}">${post.author || "Nezn√°m√Ω"}</a>`
                    : `<span class="user-link" style="color:#aaa;pointer-events:none;" title="${post.author || "Nezn√°m√Ω"}">${post.author || "Nezn√°m√Ω"}</span>`
                }
                <span class="material-icons comment-toggle" title="P≈ôidat koment√°≈ô">chat_bubble_outline</span>
                <a href="${post.url}" target="_blank" class="post-link" title="Otev≈ô√≠t p≈ô√≠spƒõvek">
                  <span class="material-icons">open_in_new</span>
                </a>
              </div>
              <div class="card-body">${extractCleanText(post.text || "")}</div>
              <div class="comments-list" id="${commentsId}">
                <span style="color:#bbb;">Naƒç√≠t√°m koment√°≈ôe...</span>
              </div>
              <div class="card-footer">
                <input type="text" placeholder="Koment√°≈ô..." class="comment-input" id="input_${post._id}">
                <button class="add-comment-btn" id="btn_${post._id}" disabled>Odeslat</button>
              </div>
            </div>
          `;
        }
        html += '</div></div>';
        colorIdx++;
      }
      container.innerHTML = html;

      for (const day of Object.keys(days)) {
        for (const post of days[day]) {
          const commentsId = "comments_" + post._id;
          fetchComments(post._id, (comments) => {
            const el = document.getElementById(commentsId);
            if (!comments) {
              el.innerHTML = '<span style="color:#bbb;">(≈Ω√°dn√© koment√°≈ôe)</span>';
              return;
            }
            el.innerHTML = Object.values(comments).map(c => `
              <div class="comment-item">
                ${c.text}
                <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', {day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit',minute:'2-digit'})}</span>
              </div>
            `).join('');
          });

          setTimeout(() => {
            const card = document.getElementById(`post_${post._id}`);
            const input = card.querySelector(`.comment-input`);
            const btn = card.querySelector(`.add-comment-btn`);
            const footer = card.querySelector(`.card-footer`);
            const commentsDiv = card.querySelector(`.comments-list`);
            const toggle = card.querySelector(`.comment-toggle`);
            toggle.addEventListener('click', () => {
              footer.classList.toggle('active');
              commentsDiv.classList.toggle('active');
              if (footer.classList.contains('active')) input.focus();
            });
            input.addEventListener('input', () => {
              btn.disabled = !input.value.trim();
            });
            btn.addEventListener('click', () => {
              if (!input.value.trim()) return;
              btn.disabled = true;
              addComment(post._id, input.value.trim(), () => {
                input.value = "";
                btn.disabled = false;
                fetchComments(post._id, (comments) => {
                  const el = card.querySelector(`.comments-list`);
                  if (!comments) {
                    el.innerHTML = '<span style="color:#bbb;">(≈Ω√°dn√© koment√°≈ôe)</span>';
                    return;
                  }
                  el.innerHTML = Object.values(comments).map(c => `
                    <div class="comment-item">
                      ${c.text}
                      <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', {day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit',minute:'2-digit'})}</span>
                    </div>
                  `).join('');
                });
              });
            });
          }, 10);
        }
      }
    }
  </script>
</body>
</html>
