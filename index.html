<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Facebook Poptávky (Firebase)</title>
  <script type="module" src="https://unpkg.com/@material/web/all.js?module"></script>
  <style>
    body {
      font-family: Roboto, Arial, sans-serif;
      background: #f5f7fa;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      color: #222;
      margin-bottom: 2rem;
      font-size: 2.3rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(410px, 1fr));
      gap: 2rem;
    }
    mwc-card {
      box-shadow: 0 2px 10px #0001;
      border-radius: 20px;
      min-height: 180px;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .meta {
      display: flex;
      align-items: center;
      gap: 1em;
      color: #666;
      font-size: 1.02rem;
      margin-bottom: 0.4em;
    }
    .meta .material-icons { font-size: 1.2em; }
    .card-body {
      padding: 1.3em 1.6em 0 1.6em;
      flex: 1;
    }
    .text {
      font-size: 1.13em;
      margin-bottom: 1.2em;
      white-space: pre-wrap;
      color: #222;
    }
    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.3em 1.2em 1.1em 1.2em;
      background: transparent;
      border-top: 1px solid #f0f0f0;
      gap: 0.8em;
    }
    .card-actions {
      display: flex;
      gap: 0.4em;
      align-items: center;
    }
    .comment-area {
      display: flex;
      align-items: flex-end;
      gap: 0.4em;
      margin-top: 0.8em;
    }
    .comment-area mwc-textfield {
      flex: 1;
    }
    .comments-list {
      margin: 0.7em 0 0.2em 0;
      color: #0a539a;
      font-size: .99em;
      background: #f5fafd;
      border-radius: 9px;
      padding: 0.4em 0.7em;
    }
    .comments-list .author {
      color: #1976d2;
      font-weight: bold;
      margin-right: 0.3em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📝 Facebook Poptávky</h1>
    <div id="root" class="grid"></div>
  </div>
  <script type="module">
    // Firebase endpoint (poptávky)
    const FIREBASE_URL = "https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky.json";
    const FIREBASE_COMMENTS = "https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/komentare";

    function escapeHTML(str) {
      return (str || "").replace(/[&<>"']/g, tag => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[tag]));
    }
    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return d.toLocaleString('cs-CZ', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }
    function makeUserLink(name, url) {
      if (!url) return escapeHTML(name);
      return `<a href="${url}" target="_blank" rel="noopener" style="color:#1976d2;text-decoration:none;font-weight:500">${escapeHTML(name)}</a>`;
    }
    // --- načte komentáře ke konkrétnímu příspěvku (podle jeho URL hash) ---
    async function fetchComments(postUrl) {
      const hash = btoa(postUrl || "").replace(/=+$/,'');
      const res = await fetch(`${FIREBASE_COMMENTS}/${hash}.json`);
      if (!res.ok) return [];
      const data = await res.json();
      if (!data) return [];
      // Pole: [{author, text, time}]
      return Object.values(data).sort((a,b)=> (a.time||"").localeCompare(b.time||""));
    }
    // --- uloží komentář k příspěvku ---
    async function postComment(postUrl, author, text) {
      const hash = btoa(postUrl || "").replace(/=+$/,'');
      const item = {
        author, text, time: new Date().toISOString()
      };
      await fetch(`${FIREBASE_COMMENTS}/${hash}.json`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(item)
      });
    }

    // Načte data a vygeneruje grid
    async function loadData() {
      const root = document.getElementById('root');
      root.innerHTML = '<mwc-circular-progress indeterminate></mwc-circular-progress>';

      try {
        const res = await fetch(FIREBASE_URL);
        const data = await res.json();
        if (!data) {
          root.innerHTML = '<p>Žádné záznamy</p>';
          return;
        }
        // Nejnovější nahoře
        const items = Object.entries(data).map(([id, v]) => ({id, ...v}))
          .sort((a, b) => (b.time || '').localeCompare(a.time || ''));

        root.innerHTML = items.map(item => `
          <mwc-card>
            <div class="card-body">
              <div class="meta">
                <span class="material-icons" style="color:#1976d2;">person</span>
                <span>${makeUserLink(item.author || "Neznámý", item.userUrl)}</span>
                <span class="material-icons" style="color:#666;margin-left:10px;">schedule</span>
                <span>${formatDate(item.time)}</span>
                ${item.url ? `<a href="${item.url}" target="_blank" rel="noopener" style="margin-left:auto;" title="Otevřít příspěvek">
                  <span class="material-icons" style="color:#0079c4;vertical-align:middle;font-size:1.4em;">open_in_new</span>
                </a>` : ""}
              </div>
              <div class="text">${escapeHTML(item.text || "")}</div>
              <div class="comments-list" id="cmtlist-${item.id}" style="display:none"></div>
              <div class="comment-area">
                <mwc-textfield id="cmtinp-${item.id}" label="Přidat komentář" outlined dense></mwc-textfield>
                <mwc-button id="cmtbtn-${item.id}" icon="send" label="Odeslat" dense></mwc-button>
                <mwc-button id="showcmt-${item.id}" icon="forum" label="Zobrazit" dense></mwc-button>
              </div>
            </div>
            <div class="card-footer"></div>
          </mwc-card>
        `).join('');

        // Po renderu, napoj události na komentáře
        for (const item of items) {
          // Přidat komentář
          document.getElementById(`cmtbtn-${item.id}`).onclick = async () => {
            const inp = document.getElementById(`cmtinp-${item.id}`);
            const txt = inp.value.trim();
            if (!txt) return inp.focus();
            let author = prompt("Jméno autora komentáře:");
            if (!author) author = "Anonym";
            await postComment(item.url, author, txt);
            inp.value = "";
            showComments(item.id, item.url);
          };
          // Zobrazit komentáře
          document.getElementById(`showcmt-${item.id}`).onclick = () => showComments(item.id, item.url);
        }
      } catch (e) {
        root.innerHTML = `<p style="color:crimson">Chyba načítání dat</p>`;
      }
    }

    // Funkce na zobrazení komentářů
    async function showComments(id, url) {
      const el = document.getElementById(`cmtlist-${id}`);
      el.innerHTML = "<span style='color:#1976d2'>Načítám komentáře...</span>";
      el.style.display = "block";
      const comments = await fetchComments(url);
      if (!comments.length) {
        el.innerHTML = "<span style='color:#888'>Žádné komentáře</span>";
        return;
      }
      el.innerHTML = comments.map(cmt => `
        <div><span class="author">${escapeHTML(cmt.author)}:</span> ${escapeHTML(cmt.text)}
        <span style="color:#888;font-size:.93em;margin-left:8px">${formatDate(cmt.time)}</span></div>
      `).join('');
    }

    loadData();
    setInterval(loadData, 60000);
  </script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</body>
</html>
