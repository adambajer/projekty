<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>📋 Facebook Poptávky</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { background: #f5f6fa; font-family: 'Roboto', 'Segoe UI', Arial, sans-serif; margin: 0; }
    .main-title { display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; margin-top: 2rem; margin-bottom: 2.5rem; color: #222; gap: 0.7rem;}
    #posts { display: grid; grid-template-columns: repeat(auto-fit, minmax(370px, 1fr)); gap: 2rem; margin: 0 auto 3rem auto; max-width: 1700px; padding: 0 2vw;}
    .card { background: #fff; border-radius: 20px; box-shadow: 0 4px 24px 0 #0001; padding: 1.4rem 1.6rem 1.2rem 1.6rem; display: flex; flex-direction: column; min-height: 170px; transition: box-shadow 0.18s; position: relative; overflow: hidden; }
    .card:hover { box-shadow: 0 6px 36px 0 #0002; }
    .card-header { font-size: 1.13rem; font-weight: 500; display: flex; align-items: center; margin-bottom: 0.3rem; gap: 0.7em; flex-wrap: wrap; }
    .user-link { color: #1976d2; text-decoration: none; font-weight: 600; margin-right: 1rem;}
    .user-link:hover { text-decoration: underline; }
    .date { color: #777; font-size: 0.98em; margin-left: 0.3em; margin-right: 0.6em; display: flex; align-items: center; gap: 0.2em;}
    .post-link { margin-left: auto; color: #1976d2; text-decoration: none; display: flex; align-items: center; font-size: 1.18em;}
    .post-link:hover { color: #145ca7; }
    .card-body { margin: 0.6rem 0 1.1rem 0; font-size: 1.12rem; color: #1a232e; word-break: break-word; min-height: 50px; flex: 1 1 auto; white-space: pre-line; }
    .card-footer { margin-top: auto; display: flex; gap: 0.4rem; align-items: center; padding-top: 0.6rem; border-top: 1px solid #f2f2f2; }
    .comment-input { flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 0.43rem 0.85rem; font-size: 1.03rem; transition: border 0.2s; outline: none;}
    .comment-input:focus { border: 1.5px solid #1976d2; }
    .add-comment-btn { border: none; background: #1976d2; color: #fff; padding: 0.48rem 1.1rem; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: background 0.16s;}
    .add-comment-btn:hover { background: #1357a6;}
    .comments-list { margin-top: 0.6rem; padding-left: 0.4rem; }
    .comment-item { color: #444; background: #f8fafc; border-radius: 9px; margin-bottom: 5px; padding: 0.35em 0.8em; font-size: 0.98em; }
    .comment-item .comment-date { color: #aaa; font-size: 0.9em; margin-left: 0.7em;}
    @media (max-width: 800px) {
      #posts { grid-template-columns: 1fr; }
      .main-title { font-size: 1.45rem; }
      .card { padding: 1.15rem 0.8rem 1rem 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="main-title">
    <span class="material-icons" style="font-size:2.5rem; color:#e96458;">edit_note</span>
    Facebook Poptávky
  </div>
  <div id="run-log" style="margin:0 auto 2rem auto; max-width:900px; color:#555;"></div>

  <div id="posts">Načítám...</div>
  <script>
    // URL na data z Firebase:
    const FIREBASE_URL = "https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky.json";
    // Komentáře ukládáme do /poptavky/{postId}/comments.json
function fetchRunLog() {
  fetch("https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/runs.json")
    .then(r=>r.json())
    .then(data => {
      if (!data) return;
      let arr = Object.values(data).sort((a, b) => new Date(b.started) - new Date(a.started)).slice(0,10);
      let html = "<b>Poslední běhy:</b><br><table style='width:100%;font-size:0.97em;margin-top:7px;'><tr><th>Začátek</th><th>Konec</th><th>Doba</th><th>Zpracováno</th><th>Nové</th></tr>";
      for (const run of arr) {
        html += `<tr>
          <td>${new Date(run.started).toLocaleString('cs-CZ')}</td>
          <td>${new Date(run.finished).toLocaleString('cs-CZ')}</td>
          <td>${run.duration_sec}s</td>
          <td>${run.total}</td>
          <td>${run.saved}</td>
        </tr>`;
      }
      html += "</table>";
      document.getElementById("run-log").innerHTML = html;
    });
}
fetchRunLog();
setInterval(fetchRunLog, 45000); // každých 45s

    function extractPostDate(text) {
      const months = ["ledna","února","března","dubna","května","června","července","srpna","září","října","listopadu","prosince"];
      const re = /(\d{1,2})\.\s*(ledna|února|března|dubna|května|června|července|srpna|září|října|listopadu|prosince)\s*v\s*(\d{1,2}:\d{2})/i;
      const match = text.match(re);
      if (!match) return null;
      const day = parseInt(match[1]);
      const month = months.indexOf(match[2].toLowerCase());
      const time = match[3];
      if (month === -1) return null;
      const year = (new Date()).getFullYear();
      const dateStr = `${year}-${(month+1).toString().padStart(2,"0")}-${day.toString().padStart(2,"0")}T${time}:00`;
      return new Date(dateStr);
    }

    function fetchComments(postId, cb) {
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`)
        .then(resp => resp.json())
        .then(comments => cb(comments))
        .catch(() => cb(null));
    }

    function addComment(postId, text, cb) {
      const commentObj = {
        text,
        time: new Date().toISOString()
      };
      fetch(`https://poptavky-b6fa1-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(commentObj)
      }).then(() => cb && cb());
    }

    fetch(FIREBASE_URL)
      .then(resp => resp.json())
      .then(data => renderPosts(data))
      .catch(() => {
        document.getElementById('posts').innerHTML = '<div style="color:#f55;font-weight:bold">Chyba při načítání dat</div>';
      });

    function renderPosts(data) {
      const container = document.getElementById('posts');
      if (!data) {
        container.innerHTML = '<div style="color:#999">Žádné příspěvky...</div>';
        return;
      }
      // --- získat id pro každý post
      const items = Object.entries(data)
        .map(([id, post]) => ({...post, _id: id}))
        .sort((a, b) => {
          const d1 = extractPostDate(a.text || "") || new Date(0);
          const d2 = extractPostDate(b.text || "") || new Date(0);
          return d2 - d1;
        });
      container.innerHTML = '';
      for (const post of items) {
        let realDate = extractPostDate(post.text || "");
        let showDate = realDate
          ? realDate.toLocaleString('cs-CZ', { day: "2-digit", month: "2-digit", year: "numeric", hour: "2-digit", minute: "2-digit" })
          : "";

        // --- generujeme jedinečný element id pro komentáře u každého postu
        const commentsId = "comments_" + post._id;
        container.innerHTML += `
          <div class="card" id="post_${post._id}">
            <div class="card-header">
              <span class="material-icons" title="Profil">person</span>
              ${
                post.userUrl
                  ? `<a href="${post.userUrl}" target="_blank" class="user-link" title="Profil na Facebooku">${post.author || "Neznámý"}</a>`
                  : `<span class="user-link" style="color:#aaa;pointer-events:none;">${post.author || "Neznámý"}</span>`
              }
              <span class="date"><span class="material-icons" style="font-size:1em;vertical-align:-2px;">schedule</span>
                ${showDate}
              </span>
              <a href="${post.url}" target="_blank" class="post-link" title="Otevřít příspěvek">
                <span class="material-icons">open_in_new</span>
              </a>
            </div>
            <div class="card-body">${post.text || ""}</div>
            <div class="comments-list" id="${commentsId}">
              <span style="color:#bbb;">Načítám komentáře...</span>
            </div>
            <div class="card-footer">
              <input type="text" placeholder="Komentář..." class="comment-input" id="input_${post._id}">
              <button class="add-comment-btn" id="btn_${post._id}" disabled>Odeslat</button>
            </div>
          </div>
        `;
        // --- hned načti komentáře
        fetchComments(post._id, (comments) => {
          const el = document.getElementById(commentsId);
          if (!comments) {
            el.innerHTML = '<span style="color:#bbb;">(Žádné komentáře)</span>';
            return;
          }
          el.innerHTML = Object.values(comments).map(c => `
            <div class="comment-item">
              ${c.text}
              <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', {day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit',minute:'2-digit'})}</span>
            </div>
          `).join('');
        });

        // --- komentář input eventy
        setTimeout(() => {
          const input = document.getElementById(`input_${post._id}`);
          const btn = document.getElementById(`btn_${post._id}`);
          input.addEventListener('input', () => {
            btn.disabled = !input.value.trim();
          });
          btn.addEventListener('click', () => {
            if (!input.value.trim()) return;
            btn.disabled = true;
            addComment(post._id, input.value.trim(), () => {
              input.value = "";
              btn.disabled = false;
              fetchComments(post._id, (comments) => {
                const el = document.getElementById(commentsId);
                if (!comments) {
                  el.innerHTML = '<span style="color:#bbb;">(Žádné komentáře)</span>';
                  return;
                }
                el.innerHTML = Object.values(comments).map(c => `
                  <div class="comment-item">
                    ${c.text}
                    <span class="comment-date">${new Date(c.time).toLocaleString('cs-CZ', {day:'2-digit',month:'2-digit',year:'numeric', hour:'2-digit',minute:'2-digit'})}</span>
                  </div>
                `).join('');
              });
            });
          });
        }, 10);
      }
    }
  </script>
</body>
</html>
