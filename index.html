<!DOCTYPE html>
<html lang="cs">

<head>
  <meta charset="UTF-8">
  <title>üìã Facebook Popt√°vky</title>
  <meta name="theme-color" content="#1976D2">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet"><!-- DataTables CSS & JS CDN -->

  <style>
    :root {
      --primary: #1976d2;
      --primary-dark: #1254a0;
    }

    body {
      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
      margin: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    .main-title {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.2rem;
      font-weight: bold;
      margin-top: 2rem;
      margin-bottom: 2.5rem;
      color: #222;
      gap: 0.7rem;
    }

    #run-log {
      color: #555;
      position: fixed;

      bottom: 0px;
      z-index: 6;
      font-size: 1.04em;

      display: flex;
      flex-wrap: wrap;
      align-items: center;
      font-size: .99em;
      justify-content: center;
    }

    #run-log div {
      box-shadow: 0 2px 10px #0001;
      padding: 10px;
      gap: 0.3em;
      background: #ffffff8e;
      border: 1px solid #ddd;
      backdrop-filter: blur(4px);
      z-index: 2000 !important;
    }

    #run-log div span {
      padding-right: 2px;
      font-size: 1rem;
    }

    #posts {
      max-width: 1800px;
      margin: 0 auto 3.5rem auto;
      padding: 0 2vw;
    }

    .day-row {
      display: grid;
      grid-template-columns: 15px 1fr;
      /* timeline + karty */
      align-items: start;
      min-height: 90px;
    }

    .timeline {
      position: relative;
      width: 30px;
      min-height: 90px;
      display: flex;
      align-items: flex-start;
      height: 100%;

      justify-content: flex-start;
    }

    .timeline-line {
      width: 3px;
      height: 100%;
      background: var(--primary, #1976d2);
      z-index: 0;
    }

    .timeline-dot {
      width: 15px;
      height: 30px;
      background: var(--primary);
      transform: translate(-55%, 0px);
      z-index: 1;
    }

    .timeline-date,
    .timeline-dot {
      position: sticky;
      top: 0px;
      left: 0px;
      z-index: 5;
    }

    .timeline-date {
      transform: translate(10px, 0px);
      display: inline-block;
      background-color: white;
      padding: 5px;
    }

    .day-row {
      position: relative;
      margin-top: 5px
        /* nic v√≠c nemus√≠≈° */
    }

    .timeline-date {
      font-size: 1rem;
      color: var(--primary, #1976d2);
      font-weight: bold;
      white-space: nowrap;
      z-index: 2;
    }

    .card {
      display: block;
      break-inside: avoid;
      padding: 0.5rem;
      /* border: 1px solid #ccc;  <-- SMA≈Ω! */
      box-shadow: 0 0 0 1px #ccc;
      background: #fff;
      margin-bottom: 0rem;
      /* Pro jistotu, aby se neklepaly */
    }

    .cards-day {
      display: block;
      column-count: 4;
      column-gap: 0rem;
      /* Tohle urƒçuje mezeru mezi kartami */
      margin-top: 0rem;
      padding-bottom: 2rem;
      /* Pro jistotu, aby se neklepaly */

    }



    .profil {
      font-size: 1em;
      color: var(--primary, #1976d2);

    }


    #posts {
      max-width: 1800px;
      margin: 0 auto 3.5rem auto;
      padding: 0;
      /* ≈Ω√°dn√© vnit≈ôn√≠ odsazen√≠ */
    }



    .card:hover {
      box-shadow: 0 6px 36px 0 #0002;
    }

    .card-time {
      font-weight: bold;
      font-size: 0.96em;
      color: #000;
    }

    .card-header {
      font-size: 1em;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.35em;
      margin-bottom: 0.13rem;
      min-width: 0;
    }

    .profil {}

    .user-link {
      text-decoration: none;
      font-weight: 600;
      margin-right: 1rem;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-block;
      font-size: 1em;
      color: #000;

      color: black;
      vertical-align: middle;
    }

    .user-link[title]:hover {
      text-decoration: underline;
    }

    .date {
      display: none !important;
    }

    .post-link {
      margin-left: auto;
      text-decoration: none;
      display: flex;
      align-items: center;
      font-size: 1.18em;
    }

    .post-link:hover {}

    .card {
      position: relative;
    }

    .card .comment-toggle {
      position: absolute;
      right: 0.7em;
      bottom: 0.7em;
      margin: 0;
      color: #000;
      opacity: 0.8;
      font-size: 1.15em;
      transition: color 0.2s, opacity 0.2s;
      z-index: 2;

    }

    .card .comment-toggle:hover {
      color: var(--primary);
      opacity: 1;
    }


    .card-body {
      margin: 0.25rem 0 0.7rem 0;
      font-size: 1.07rem;
      color: #1a232e;
      word-break: break-word;
      min-height: 34px;
      flex: 1 1 auto;
      padding: 0;
      /* men≈°√≠ padding textu */
      white-space: pre-line;
    }

    .card-footer,
    .comments-list {
      display: none;
    }

    .card-footer.active,
    .comments-list.active {
      display: flex;
    }

    .card-footer {
      margin-top: auto;
      gap: 0.4rem;
      align-items: center;
      padding-top: 0.6rem;
      border-top: 1px solid #f2f2f2;
    }

    .comment-item {
      padding: 0.23em 0.6em;
      font-size: 0.95em;
      margin-bottom: 2px;
      border-radius: 7px;
    }

    .comment-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 0.43rem 0.85rem;
      font-size: 1.03rem;
      transition: border 0.2s;
      outline: none;
    }

    .comment-input:focus {
      border: 1.5px solid var(--primary);
    }

    .add-comment-btn {
      border: none;
      background: var(--primary);
      color: #fff;
      padding: 0.48rem 1.1rem;
      border-radius: 8px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.16s;
    }

    .add-comment-btn:hover {
      background: var(--primary-dark);
    }

    .comments-list {
      margin-top: 0.6rem;
      padding-left: 0.4rem;
      flex-direction: column;
    }

    .comment-item {
      color: #444;
      background: #f8fafc;
      border-radius: 9px;
      margin-bottom: 5px;
      padding: 0.35em 0.8em;
      font-size: 0.98em;
    }

    .comment-item .comment-date {
      color: #aaa;
      font-size: 0.9em;
      margin-left: 0.7em;
    }

    @media (max-width: 1050px) {
      .card {
        min-width: 260px;
        max-width: 100%;
      }

      .cards-day {
        gap: 1.1rem;
      }
    }

    @media (max-width: 800px) {
      #posts {
        padding: 0;
      }

      .main-title {
        font-size: 1.45rem;
      }

      .card {
        padding: 1.15rem 0.8rem 1rem 0.9rem;
      }

      .day-row {
        flex-direction: column;
        gap: 0.7rem;
        padding-bottom: 0.7rem;
        margin-bottom: 1rem;
      }

      .timeline-date {
        text-align: left;
        margin-bottom: 8px;
        position: static !important;
        border-radius: 0;
        background: none;
        box-shadow: none;
      }
    }

    .openinnew {
      color: #000;

      font-size: 1rem;
      ;
    }

    .filter-btn {
      font-size: 1.04em;
      padding: 0.3em;
      /* border-radius: 1.5em; */
      border: 1px solid #d1d7e2;
      /* background: #e3f1ff; */
      color: #144e7a;
      /* font-weight: 600; */
      cursor: pointer;
      margin-right: 0.7em;
      transition: background 0.13s, color 0.13s, border 0.13s;
    }

    .filter-btn:last-child {
      margin-right: 0;
    }

    .filter-btn:hover {
      background: #b9e2ff;
      color: #17497a;
      border-color: #1976d2;
    }

    .custom-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(60, 70, 100, 0.17);
      backdrop-filter: blur(2px);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #fff;
      padding: 2.6em 2.9em 2.2em 2.9em;
      border-radius: 26px;
      max-width: 900px;
      width: 94vw;
      max-height: 95vh;
      overflow-y: auto;
      box-shadow: 0 16px 48px 0 #0004;
      position: relative;
      min-width: 300px;
    }

    .modal-title {
      font-size: 1.37em;
      font-weight: 700;
      margin-bottom: 1.6em;
      letter-spacing: .02em;
    }

    .close-modal {
      position: absolute;
      right: 22px;
      top: 18px;
      background: none;
      border: none;
      font-size: 2em;
      opacity: .4;
      cursor: pointer;
      transition: opacity .14s;
    }

    .close-modal:hover {
      opacity: .7;
    }

    .chips-box {
      display: flex;
      flex-wrap: wrap;
      gap: 0.7em 0.45em;
      /* vƒõt≈°√≠ mezery, prvn√≠ je ≈ô√°dek, druh√° sloupec */
      margin-top: 0.3em;
    }

    .kw-chip,
    .ex-chip {
      display: inline-block;
      padding: 0.37em 1.3em;
      font-size: 1.08em;
      border-radius: 1.5em;
      background: #e3f1ff;
      color: #144e7a;
      font-weight: 500;
      border: 1px solid #bcdfff;
      margin-bottom: 0;
      user-select: all;
      transition: background 0.14s, color 0.14s, border 0.14s;
    }

    .ex-chip {
      background: #ffe3e3;
      color: #7a1414;
      border: 1px solid #ffd4d4;
    }

    .kw-chip:hover,
    .ex-chip:hover {
      background: #b9e2ff;
      color: #144e7a;
    }

    .ex-chip:hover {
      background: #ffd4d4;
      color: #7a1414;
    }

    @media (max-width: 700px) {
      .modal-content {
        padding: 1.6em 0.8em 1.2em 0.8em;
      }

      .chips-box {
        gap: 0.48em 0.15em;
      }

      .kw-chip,
      .ex-chip {
        padding: 0.2em 0.75em;
        font-size: 1em;
      }
    }

    .nav-tabs {
      display: flex;
      border-bottom: 2.5px solid #e4e8f0;
      background: #f9fbfe;
      padding: 0 0.6em;
      border-radius: 1.1em 1.1em 0 0;
      box-shadow: 0 2px 10px #0001;
      margin-bottom: 1.4em;
      gap: 0.3em;
    }

    .nav-tabs .nav-item {
      list-style: none;
    }

    .nav-tabs .nav-link {
      display: inline-block;
      color: #1976d2;
      font-weight: 600;
      font-size: 1.07em;
      padding: 0.69em 2.2em 0.5em 2.2em;
      background: none;
      border: none;
      border-radius: 1em 1em 0 0;
      border-bottom: 2.5px solid transparent;
      transition:
        color 0.15s,
        background 0.18s,
        border-bottom 0.16s;
      cursor: pointer;
      margin-right: 0.3em;
      outline: none;
      box-shadow: none;
      text-decoration: none;
      position: relative;
      top: 2px;
    }

    .nav-tabs .nav-link:hover,
    .nav-tabs .nav-link:focus {
      background: #e9f2fb;
      color: #1560a6;
    }

    .nav-tabs .nav-link.active {
      color: #1254a0;
      background: #fff;
      border-bottom: 2.5px solid #1976d2;
      box-shadow: 0 7px 22px 0 #1976d219;
      z-index: 2;
    }

    @media (max-width: 700px) {
      .nav-tabs .nav-link {
        padding: 0.55em 1.05em 0.35em 1.05em;
        font-size: 0.98em;
      }
    }

    .simple-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1.11em;
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 3px 20px #0001;
      overflow: hidden;
      margin: 0 auto;
      min-width: 220px;
      max-width: 460px;
    }

    .simple-table th,
    .simple-table td {
      padding: 0.61em 1.1em;
      border-bottom: 1px solid #ecf1f8;
      text-align: left;
    }

    .simple-table th {
      background: #f6fafd;
      color: #1976d2;
      font-size: 1.09em;
      font-weight: 600;
      user-select: none;
    }

    .simple-table tr:last-child td {
      border-bottom: none;
    }

    .simple-table tbody tr:hover td {
      background: #e8f4ff;
    }

    .kw-table-container {
      margin: 0 auto;
    }

    .kw-table-headrow,
    .kw-table-row {
      display: flex;
      align-items: center;
      min-height: 38px;
      border-bottom: 1px solid #f1f3f9;
      padding: 0 8px;
      font-size: 1.06em;
    }

    .kw-table-headrow {
      background: #f6fafd;
      font-weight: 700;
      color: #1976d2;
      border-radius: 9px 9px 0 0;
      min-height: 38px;
    }

    .kw-table-row {
      background: #fff;
      transition: background .13s;
    }

    .kw-table-row:hover {
      background: #f0f6fd;
    }

    .kw-table-cell {
      flex: 1;
      padding: 3px 2px 3px 7px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .kw-table-actions {
      min-width: 44px;
      display: flex;
      gap: 4px;
      justify-content: flex-end;
    }

    .kw-icon-btn {
      border: none;
      background: none;
      padding: 3px;
      margin: 0 0 0 4px;
      cursor: pointer;
      opacity: 0.65;
      border-radius: 6px;
      transition: opacity .13s, background .13s;
      line-height: 1;
    }

    .kw-icon-btn:hover {
      opacity: 1;
      background: #e9f3ff;
    }

    .kw-icon {
      width: 17px;
      height: 17px;
      display: inline-block;
      vertical-align: middle;
      fill: #1976d2;
    }

    .kw-table-select {
      margin-right: 9px;
    }

    .kw-table-input {

      padding: 4px 8px;
      font-size: 1em;
      border: 1px solid #e4e7ef;
      border-radius: 6px;
    }

    .kw-table-filter {
      margin-bottom: 0.8em;

      max-width: 260px;
      padding: 6px 1em;
      border-radius: 10px;
      border: 1.2px solid #d1d7e2;
      font-size: 1.05em;
    }

    .kw-table-cell {
      padding: 2px 4px 2px 7px;
      font-size: 1em;
    }

    .kw-icon-btn {
      margin: 0 0 0 4px;
    }

    .kw-table-actions-vertical {
      display: flex;
      flex-direction: row;
      gap: 2px;
      align-items: flex-end;
      justify-content: center;
      margin-left: 8px;
      min-width: 26px;
    }

    .kw-icon-btn {
      border: none;
      background: none;
      padding: 3px;
      margin: 0;
      cursor: pointer;
      opacity: 0.7;
      border-radius: 6px;
      transition: opacity .13s, background .13s;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .kw-icon-btn:hover {
      opacity: 1;
      background: #e9f3ff;
    }

    .kw-table-input,
    #kw-add-input,
    #group-add-input,
    #ex-add-input {
      padding: 4px 8px;
      font-size: 1em;
      border: 1px solid #e4e7ef;
      border-radius: 6px;
      width: -webkit-fill-available;
    }

    #kw-add-btn,
    #group-add-btn,
    #ex-add-btn {
      background: #1976d2 !important;
      color: #fff !important;
      border: none;
      border-radius: 6px;
      padding: 0 20px;
      font-weight: bold;
      font-size: 1.08em;
      box-shadow: 0 1px 4px #0002;
      min-height: 32px;
      display: flex;
      align-items: center;
      gap: 0.6em;
      padding: 1rem;
      ;
      transition: background 0.18s;
    }

    #kw-add-btn:hover,
    #group-add-btn:hover,
    #ex-add-btn:hover {
      background: #1458a8 !important;
    }

    .checkmark-btn {
      position: absolute;
      right: 12px;
      bottom: 10px;
      background: transparent;
      border: 1.7px solid #c6c6c6;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 6px #0001;
      transition: background 0.18s, border 0.18s, color 0.2s;
      color: #c6c6c6;
      cursor: pointer;
      z-index: 5;
    }

    .checkmark-btn.checked {
      background: #d4f5d6 !important;
      border-color: #44c95c !important;
      color: #22a83d !important;
    }

    .checkmark-btn .material-icons {
      font-size: 1.7em;
      pointer-events: none;
    }
    .group-icon {
    
    padding: 0.37em;}
  </style>
</head>

<body>
  <div class="container" style="margin-top:2rem;margin-bottom:1.3rem;">
    <ul class="nav nav-tabs" id="postsTab" style="font-size:1.1em;">
      <li class="nav-item">
        <a class="nav-link active" data-branch="poptavky" href="#">Popt√°vky</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-branch="nabidky" href="#">Nab√≠dky</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-branch="jine" href="#">Ostatn√≠</a>
      </li>
      <li class="nav-item"> <button id="show-keywords-btn" class="filter-btn"><span class="material-icons"
            title="Doba">done_all</span> Popt√°vky slova</button>

      </li>
      <li class="nav-item"> <button id="show-excluded-btn" class="filter-btn"><span class="material-icons"
            title="Doba">local_offer</span> Nab√≠dky slova</button>

      </li>
      <li class="nav-item">
        <button id="show-groups-btn" class="filter-btn">
          <span class="material-icons" title="Skupiny">groups</span> Skupiny
        </button>
      </li>

      <button onclick="subscribeUserToPush()" class="filter-btn">Povolit notifikace</button>

    </ul>
  </div>
  <!-- Modal pro kl√≠ƒçov√° slova -->
  <div id="keywords-modal" class="custom-modal">
    <div class="modal-content">
      <button class="close-modal" id="close-keywords-modal" title="Zav≈ô√≠t">‚úï</button>
      <div class="modal-title">Popt√°vky slova</div>
      <div class="kw-table-container">
        <input id="kw-filter" class="kw-table-filter" type="search" placeholder="Filtrovat kl√≠ƒçov√° slova‚Ä¶">
        <div style="display:flex;gap:8px;margin-bottom:.8em;">
          <input id="kw-add-input" class="kw-table-input" placeholder="Nov√© slovo‚Ä¶">
          <button id="kw-add-btn" class="kw-icon-btn" title="P≈ôidat">
            P≈ôidej
          </button>
        </div>
        <div class="kw-table-headrow">
          <input type="checkbox" id="kw-bulk-select" class="kw-table-select">
          <div class="kw-table-cell" style="font-weight:700;cursor:pointer;" id="kw-sort-th">Kl√≠ƒçov√© slovo <span
              id="kw-sort-arrow" style="font-size:.93em;">‚Üë</span></div>
          <div class="kw-table-cell" style="font-weight:700;cursor:pointer;text-align:right;" id="kw-sort-count-th">
            V√Ωskyty <span id="kw-sort-count-arrow" style="font-size:.93em;"></span></div>
        </div>
        <div id="kw-table-rows"></div>
        <button id="kw-bulk-delete-btn" class="kw-icon-btn" style="margin-top:0.6em;display:none;">
          <svg class="kw-icon" viewBox="0 0 24 24">
            <path d="M3 6h18M9 6V4h6v2M8 6v14a2 2 0 002 2h4a2 2 0 002-2V6" stroke="#e63e3e" stroke-width="2"
              fill="none" />
          </svg>
          Smazat vybran√©
        </button>
        <div id="kw-admin-status" style="margin-top:1em;font-size:.97em;color:#1976d2;"></div>
      </div>
      <div id="kw-no-results" style="display:none;color:#b00;margin-top:1.5em;font-size:1.12em;text-align:center;">≈Ω√°dn√©
        slovo nenalezeno.</div>



    </div>
  </div>
  <!-- Modal pro vylouƒçen√© fr√°ze (TABULKA) -->
  <div id="excluded-modal" class="custom-modal">
    <div class="modal-content">
      <button class="close-modal" id="close-excluded-modal" title="Zav≈ô√≠t">‚úï</button>
      <div class="modal-title">Nab√≠dky slova</div>
      <div class="kw-table-container">
        <input id="ex-filter" class="kw-table-filter" type="search" placeholder="Filtrovat fr√°ze‚Ä¶">
        <div style="display:flex;gap:8px;margin-bottom:.8em;">
          <input id="ex-add-input" class="kw-table-input" placeholder="Nov√° slovo...">
          <button id="ex-add-btn" class="kw-icon-btn" title="P≈ôidat">
            P≈ôidej
          </button>
        </div>
        <div class="kw-table-headrow">
          <input type="checkbox" id="ex-bulk-select" class="kw-table-select">
          <div class="kw-table-cell" style="font-weight:700;cursor:pointer;" id="ex-sort-th">Fr√°ze <span
              id="ex-sort-arrow" style="font-size:.93em;">‚Üë</span></div>
          <div class="kw-table-cell" style="font-weight:700;cursor:pointer;text-align:right;" id="ex-sort-count-th">
            V√Ωskyty <span id="ex-sort-count-arrow" style="font-size:.93em;"></span>
          </div>
        </div>

        <div id="ex-table-rows"></div>
        <button id="ex-bulk-delete-btn" class="kw-icon-btn" style="margin-top:0.6em;display:none;">
          <svg class="kw-icon" viewBox="0 0 24 24">
            <path d="M3 6h18M9 6V4h6v2M8 6v14a2 2 0 002 2h4a2 2 0 002-2V6" stroke="#e63e3e" stroke-width="2"
              fill="none" />
          </svg>
          Smazat vybran√©
        </button>
        <div id="ex-admin-status" style="margin-top:1em;font-size:.97em;color:#1976d2;"></div>
      </div>
      <div id="ex-no-results" style="display:none;color:#b00;margin-top:1.5em;font-size:1.12em;text-align:center;">≈Ω√°dn√°
        fr√°ze nenalezena.</div>
    </div>
  </div>
  <!-- Modal pro skupiny (pouze URL) -->
  <div id="groups-modal" class="custom-modal">
    <div class="modal-content">
      <button class="close-modal" id="close-groups-modal" title="Zav≈ô√≠t">‚úï</button>
      <div class="modal-title">Skupiny</div>
      <div class="kw-table-container">
        <input id="group-filter" class="kw-table-filter" type="search" placeholder="Filtrovat skupiny‚Ä¶">
        <div style="display:flex;gap:8px;margin-bottom:.8em;">
          <input id="group-url-input" class="kw-table-input" placeholder="Nap≈ô. 558655264788206.groups.facebook.com">
          <input id="group-name-input" class="kw-table-input" placeholder="N√°zev skupiny">
          <button id="group-add-btn" class="kw-icon-btn" title="P≈ôidat">P≈ôidej</button>
        </div>
        <div class="kw-table-headrow">
          <div class="kw-table-cell" style="font-weight:700;">URL skupiny</div>
          <div class="kw-table-cell" style="font-weight:700;">N√°zev</div>
          <div class="kw-table-actions" style="font-weight:700;">Akce</div>
        </div>


        <div id="group-table-rows"></div>
        <div id="group-admin-status" style="margin-top:1em;font-size:.97em;color:#1976d2;"></div>
      </div>
      <div id="group-no-results" style="display:none;color:#b00;margin-top:1.5em;font-size:1.12em;text-align:center;">
        ≈Ω√°dn√° skupina nenalezena.</div>
    </div>
  </div>



  <div id="run-log"></div>
  <div id="posts">Naƒç√≠t√°m...</div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('/sw.js').then(function (reg) {
          // console.log('SW registered', reg);
        });
      });
    }
    // === SKUPINY (pouze URL) ===

    const GROUPS_FIREBASE_URL = "https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/groups.json";
    let groupData = [];
    let groupEditingIndex = null;

    function groupStatus(msg, err) {
      const el = document.getElementById("group-admin-status");
      el.style.color = err ? "#e63e3e" : "#1976d2";
      el.textContent = msg;
      setTimeout(() => { el.textContent = ""; }, 1800);
    }

    function groupLoadTable() {
      fetch(GROUPS_FIREBASE_URL).then(r => r.json()).then(arr => {
        if (!Array.isArray(arr)) arr = [];
        groupData = arr;
        groupEditingIndex = null;
        groupRenderTable();
      });
    }

    function groupRenderTable() {
      const rows = document.getElementById("group-table-rows");
      const filterVal = document.getElementById("group-filter").value.trim().toLowerCase();
      let data = groupData
        .map((g, i) => ({ ...g, i }))
        .filter(obj => !filterVal ||
          obj.id.toLowerCase().includes(filterVal) ||
          obj.name.toLowerCase().includes(filterVal)
        );
      let html = data.map(({ id, name, i }) => `
    <div class="kw-table-row${groupEditingIndex === i ? " editing" : ""}">
      <div class="kw-table-cell">
        ${groupEditingIndex === i
          ? `<input class="kw-table-input" id="group-edit-url-input" value="${id.replace(/"/g, '&quot;')}">`
          : `<a href="https://${id}" target="_blank">${id}</a>`
        }
      </div>
      <div class="kw-table-cell">
        ${groupEditingIndex === i
          ? `<input class="kw-table-input" id="group-edit-name-input" value="${name.replace(/"/g, '&quot;')}">`
          : `<span>${name}</span>`
        }
      </div>
      <div class="kw-table-actions-vertical">
        ${groupEditingIndex === i
          ? `
            <button class="kw-icon-btn" title="Ulo≈æit" data-action="save" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke="#1c932c" stroke-width="2.5" fill="none" stroke-linecap="round"/></svg>
            </button>
            <button class="kw-icon-btn" title="Zru≈°it" data-action="cancel" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="#b3b3b3" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </button>
          `
          : `
            <button class="kw-icon-btn" title="Upravit" data-action="edit" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z" /></svg>
            </button>
            <button class="kw-icon-btn" title="Smazat" data-action="delete" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M6 19a2 2 0 002 2h8a2 2 0 002-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#e63e3e"/></svg>
            </button>
          `
        }
      </div>
    </div>
  `).join("");
      rows.innerHTML = html;
      document.getElementById("group-no-results").style.display = data.length ? "none" : "";
    }


    document.getElementById("group-add-btn").onclick = function () {
      let id = document.getElementById("group-url-input").value.trim().replace(/^https?:\/\//, "");
      let name = document.getElementById("group-name-input").value.trim();
      if (!id || !name) return groupStatus("Zadej URL i n√°zev!", true);
      if (groupData.some(g => g.id === id)) return groupStatus("Skupina u≈æ existuje!", true);
      groupData.push({ id, name });
      groupSaveAll("Skupina p≈ôid√°na.");
      document.getElementById("group-url-input").value = "";
      document.getElementById("group-name-input").value = "";
    };

    // Inline editace, maz√°n√≠, ulo≈æen√≠, cancel
    document.getElementById("group-table-rows").onclick = function (e) {
      const btn = e.target.closest("button.kw-icon-btn");
      if (!btn) return;
      const idx = parseInt(btn.dataset.i);
      const action = btn.dataset.action;
      if (action === "edit") {
        groupEditingIndex = idx; groupRenderTable();
        setTimeout(() => { document.getElementById("group-edit-url-input").focus(); }, 50);
      }
      if (action === "delete") {
        if (confirm("Opravdu smazat tuto skupinu?")) {
          groupData.splice(idx, 1);
          groupSaveAll("Skupina smaz√°na.");
        }
      }
      if (action === "save") {
        const id = document.getElementById("group-edit-url-input").value.trim().replace(/^https?:\/\//, "");
        const name = document.getElementById("group-edit-name-input").value.trim();
        if (!id || !name) return groupStatus("Zadej URL i n√°zev!", true);
        if (groupData.some((g, i2) => g.id === id && i2 !== idx)) return groupStatus("Skupina u≈æ existuje!", true);
        groupData[idx] = { id, name };
        groupEditingIndex = null;
        groupSaveAll("Skupina upravena.");
      }
      if (action === "cancel") {
        groupEditingIndex = null; groupRenderTable();
      }
    };
    // Enter p≈ôi editaci
    document.getElementById("group-table-rows").addEventListener("keydown", function (e) {
      if (e.target.id === "group-edit-url-input" && e.key === "Enter") {
        document.querySelector('#group-table-rows [data-action="save"]').click();
      }
    });

    // Filtrov√°n√≠
    document.getElementById("group-filter").oninput = function () {
      groupRenderTable();
    };

    // Ulo≈æit v≈°e do Firebase
    function groupSaveAll(msg) {
      fetch(GROUPS_FIREBASE_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(groupData)
      }).then(() => { groupStatus(msg); groupRenderTable(); });
    }

    // Otev≈ô√≠t modal
    function showGroupsModal() {
      document.getElementById("groups-modal").style.display = "flex";
      groupLoadTable();
    }
    document.getElementById("show-groups-btn").onclick = showGroupsModal;
    document.getElementById("close-groups-modal").onclick = () => hideModal("groups-modal");


    function subscribeUserToPush() {
      if (!('serviceWorker' in navigator)) return;
      navigator.serviceWorker.ready.then(reg => {
        Notification.requestPermission().then(permission => {
          if (permission !== 'granted') return alert('Notifikace zak√°z√°ny');
          reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: '<TV≈ÆJ PUBLIC VAPID KL√çƒå base64>'
          }).then(sub => {
            // Ulo≈æ sub na server (nap≈ô. do Firebase nebo vlastn√≠ API)
            // fetch('/api/save-sub', {method:'POST',body:JSON.stringify(sub),headers:{'Content-Type':'application/json'}});
            alert('Notifikace povoleny!');
          }).catch(console.error);
        });
      });
    }

    function showModal(id, fetchFn) {
      document.getElementById(id).style.display = "flex";
      if (fetchFn) fetchFn();
    }
    function hideModal(id) {
      document.getElementById(id).style.display = "none";
    }
    // Kl√≠ƒçov√° slova
    document.getElementById("show-keywords-btn").onclick = () =>
      showModal("keywords-modal", kwRenderTable);
    document.getElementById("close-keywords-modal").onclick = () =>
      hideModal("keywords-modal");

    // Zav√≠r√°n√≠ esc a klik vedle modalu
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        hideModal("keywords-modal");
      }
    });
    document.querySelectorAll('.custom-modal').forEach(modal => {
      modal.addEventListener('click', e => {
        if (e.target === modal) hideModal(modal.id);
      });
    });

    // Pokud pou≈æ√≠v√°≈° modal, v≈ædy zavolej renderKeywordsTable() p≈ôi otev≈ôen√≠ modalu s tabulkou.
    const KW_FIREBASE_URL = "https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/keywords.json";
    let kwData = [];
    let editingIndex = null;

    let kwSortAsc = true;

    function kwStatus(msg, err) {
      const el = document.getElementById("kw-admin-status");
      el.style.color = err ? "#e63e3e" : "#1976d2";
      el.textContent = msg;
      setTimeout(() => { el.textContent = ""; }, 1800);
    }

    function kwLoadTable() {
      fetch(KW_FIREBASE_URL).then(r => r.json()).then(arr => {
        if (!Array.isArray(arr)) arr = [];
        kwData = arr;
        editingIndex = null;
        kwLoadStats(kwRenderTable);  // naƒçti stats a a≈æ pak renderuj
      });
    }

    const KW_STATS_URL = "https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/kwstats.json";
    let kwStats = {};
    let kwSortByCount = false; // nov√©, pro ≈ôazen√≠ podle poƒçtu v√Ωskyt≈Ø

    function kwLoadStats(cb) {
      fetch(KW_STATS_URL).then(r => r.json()).then(obj => {
        kwStats = obj || {};
        if (cb) cb();
      });
    } function kwRenderTable() {
      const rows = document.getElementById("kw-table-rows");
      const bulkBtn = document.getElementById("kw-bulk-delete-btn");
      const filterVal = document.getElementById("kw-filter").value.trim().toLowerCase();

      let data = kwData.map((w, i) => ({
        w,
        i,
        count: (kwStats && typeof kwStats[w] !== "undefined") ? kwStats[w] : 0
      }))
        .filter(obj => !filterVal || obj.w.toLowerCase().includes(filterVal));

      // --- ≈òazen√≠ ---
      if (kwSortByCount) {
        data = data.sort((a, b) => kwSortAsc ? (a.count - b.count) : (b.count - a.count));
      } else {
        data = data.sort((a, b) => {
          const cmp = a.w.localeCompare(b.w, "cs", { sensitivity: "base" });
          return kwSortAsc ? cmp : -cmp;
        });
      }

      let html = data.map(({ w, i, count }) => `
  <div class="kw-table-row${editingIndex === i ? " editing" : ""}">
    <input type="checkbox" class="kw-table-select" data-i="${i}">
    <div class="kw-table-cell" style="display:flex;align-items:center;gap:8px;">
      ${editingIndex === i
          ? `<input class="kw-table-input" id="kw-edit-input" value="${w.replace(/"/g, '&quot;')}">`
          : `<span>${w}</span>`
        }
    </div>
    <div class="kw-table-actions-vertical">
      ${editingIndex === i
          ? `
          <button class="kw-icon-btn" title="Ulo≈æit" data-action="save" data-i="${i}">
            <svg class="kw-icon" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke="#1c932c" stroke-width="2.5" fill="none" stroke-linecap="round"/></svg>
          </button>
          <button class="kw-icon-btn" title="Zru≈°it" data-action="cancel" data-i="${i}">
            <svg class="kw-icon" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="#b3b3b3" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </button>
        `
          : `
          <button class="kw-icon-btn" title="Upravit" data-action="edit" data-i="${i}">
            <svg class="kw-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z" /></svg>
          </button>
          <button class="kw-icon-btn" title="Smazat" data-action="delete" data-i="${i}">
            <svg class="kw-icon" viewBox="0 0 24 24"><path d="M6 19a2 2 0 002 2h8a2 2 0 002-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#e63e3e"/></svg>
          </button>
        `
        }
    </div>
    <div class="kw-table-cell" style="min-width:42px;text-align:right;">${count || 0}</div>
  </div>
`).join("");
      rows.innerHTML = html;

      let selCount = document.querySelectorAll('.kw-table-select:checked').length;
      bulkBtn.style.display = selCount ? "" : "none";
    }


    // P≈ôidat nov√© slovo
    document.getElementById("kw-add-btn").onclick = function () {
      let val = document.getElementById("kw-add-input").value.trim();
      if (!val) return;
      if (kwData.includes(val)) return kwStatus("Toto slovo u≈æ existuje!", true);
      kwData.push(val);
      kwSaveAll("Slovo p≈ôid√°no.");
      document.getElementById("kw-add-input").value = "";
    };

    // Inline editace, maz√°n√≠, ulo≈æen√≠, cancel, bulk delete
    document.getElementById("kw-table-rows").onclick = function (e) {
      const btn = e.target.closest("button.kw-icon-btn");
      if (!btn) return;
      const idx = parseInt(btn.dataset.i);
      const action = btn.dataset.action;
      if (action === "edit") {
        editingIndex = idx; kwRenderTable();
        setTimeout(() => { document.getElementById("kw-edit-input").focus(); }, 50);
      }
      if (action === "delete") {
        kwData.splice(idx, 1);
        kwSaveAll("Slovo smaz√°no.");
        /*if (confirm("Opravdu smazat toto slovo?")) {
          
         
        }*/
      }
      if (action === "save") {
        const val = document.getElementById("kw-edit-input").value.trim();
        if (!val) return;
        if (kwData.includes(val)) return kwStatus("Toto slovo u≈æ existuje!", true);
        kwData[idx] = val;
        editingIndex = null;
        kwSaveAll("Slovo upraveno.");
      }
      if (action === "cancel") {
        editingIndex = null; kwRenderTable();
      }
    };
    // Enter p≈ôi editaci
    document.getElementById("kw-table-rows").addEventListener("keydown", function (e) {
      if (e.target.id === "kw-edit-input" && e.key === "Enter") {
        document.querySelector('[data-action="save"]').click();
      }
    });

    // ≈òazen√≠ klikem na z√°hlav√≠
    document.getElementById("kw-sort-th").onclick = function () {
      kwSortAsc = !kwSortAsc;
      document.getElementById("kw-sort-arrow").textContent = kwSortAsc ? "‚Üë" : "‚Üì";
      kwRenderTable();
    };
    // ≈òazen√≠ dle slova
    document.getElementById("kw-sort-th").onclick = function () {
      if (!kwSortByCount) {
        kwSortAsc = !kwSortAsc;
      } else {
        kwSortByCount = false;
        kwSortAsc = true;
      }
      document.getElementById("kw-sort-arrow").textContent = kwSortAsc ? "‚Üë" : "‚Üì";
      document.getElementById("kw-sort-count-arrow").textContent = "";
      kwRenderTable();
    };
    // ≈òazen√≠ dle v√Ωskyt≈Ø
    document.getElementById("kw-sort-count-th").onclick = function () {
      if (kwSortByCount) {
        kwSortAsc = !kwSortAsc;
      } else {
        kwSortByCount = true;
        kwSortAsc = false;
      }
      document.getElementById("kw-sort-count-arrow").textContent = kwSortAsc ? "‚Üë" : "‚Üì";
      document.getElementById("kw-sort-arrow").textContent = "";
      kwRenderTable();
    };

    // Filtrov√°n√≠
    document.getElementById("kw-filter").oninput = function () {
      kwRenderTable();
    };

    // V√Ωbƒõr v≈°ech pro bulk
    document.getElementById("kw-bulk-select").onchange = function () {
      document.querySelectorAll('.kw-table-select').forEach(cb => cb.checked = this.checked);
      document.getElementById('kw-bulk-delete-btn').style.display = this.checked ? "" : "none";
    };

    // Bulk maz√°n√≠
    document.getElementById("kw-bulk-delete-btn").onclick = function () {
      if (!confirm("Opravdu smazat vybran√° slova?")) return;
      let sel = Array.from(document.querySelectorAll('.kw-table-select:checked')).map(cb => parseInt(cb.dataset.i));
      kwData = kwData.filter((_, i) => !sel.includes(i));
      kwSaveAll("Slova smaz√°na.");
      document.getElementById("kw-bulk-select").checked = false;
    };

    // Ulo≈æit v≈°e do Firebase
    function kwSaveAll(msg) {
      fetch(KW_FIREBASE_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(kwData)
      }).then(() => { kwStatus(msg); kwRenderTable(); });
    }

    // INIT
    kwLoadTable();

    const EX_FIREBASE_URL = "https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/excluded.json";
    const EX_STATS_URL = "https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/exstats.json";
    let exData = [];
    let exStats = {};
    let exEditingIndex = null;
    let exSortAsc = true;
    let exSortByCount = false;

    function exStatus(msg, err) {
      const el = document.getElementById("ex-admin-status");
      el.style.color = err ? "#e63e3e" : "#1976d2";
      el.textContent = msg;
      setTimeout(() => { el.textContent = ""; }, 1800);
    }

    function exLoadStats(cb) {
      fetch(EX_STATS_URL).then(r => r.json()).then(obj => {
        exStats = obj || {};
        if (cb) cb();
      });
    }

    function exLoadTable() {
      fetch(EX_FIREBASE_URL).then(r => r.json()).then(arr => {
        if (!Array.isArray(arr)) arr = [];
        exData = arr;
        exEditingIndex = null;
        exLoadStats(exRenderTable); // nejd≈ô√≠v naƒçti stats a pak renderuj
      });
    }

    function exRenderTable() {
      const rows = document.getElementById("ex-table-rows");
      const bulkBtn = document.getElementById("ex-bulk-delete-btn");
      const filterVal = document.getElementById("ex-filter").value.trim().toLowerCase();

      let data = exData.map((w, i) => ({
        w,
        i,
        count: (exStats && typeof exStats[w] !== "undefined") ? exStats[w] : 0
      }))
        .filter(obj => !filterVal || obj.w.toLowerCase().includes(filterVal));

      // --- ≈òazen√≠ ---
      if (exSortByCount) {
        data = data.sort((a, b) => exSortAsc ? (a.count - b.count) : (b.count - a.count));
      } else {
        data = data.sort((a, b) => {
          const cmp = a.w.localeCompare(b.w, "cs", { sensitivity: "base" });
          return exSortAsc ? cmp : -cmp;
        });
      }

      let html = data.map(({ w, i, count }) => `
    <div class="kw-table-row${exEditingIndex === i ? " editing" : ""}">
      <input type="checkbox" class="kw-table-select" data-i="${i}">
      <div class="kw-table-cell" style="display:flex;align-items:center;gap:8px;">
        ${exEditingIndex === i
          ? `<input class="kw-table-input" id="ex-edit-input" value="${w.replace(/"/g, '&quot;')}">`
          : `<span>${w}</span>`
        }
      </div>
      <div class="kw-table-actions-vertical">
        ${exEditingIndex === i
          ? `
            <button class="kw-icon-btn" title="Ulo≈æit" data-action="save" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke="#1c932c" stroke-width="2.5" fill="none" stroke-linecap="round"/></svg>
            </button>
            <button class="kw-icon-btn" title="Zru≈°it" data-action="cancel" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12" stroke="#b3b3b3" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
            </button>
          `
          : `
            <button class="kw-icon-btn" title="Upravit" data-action="edit" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75z" /></svg>
            </button>
            <button class="kw-icon-btn" title="Smazat" data-action="delete" data-i="${i}">
              <svg class="kw-icon" viewBox="0 0 24 24"><path d="M6 19a2 2 0 002 2h8a2 2 0 002-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#e63e3e"/></svg>
            </button>
          `
        }
      </div>
      <div class="kw-table-cell" style="min-width:42px;text-align:right;">${count || 0}</div>
    </div>
  `).join("");
      rows.innerHTML = html;

      let selCount = document.querySelectorAll('#ex-table-rows .kw-table-select:checked').length;
      bulkBtn.style.display = selCount ? "" : "none";
    }

    // P≈ôidat novou fr√°zi
    document.getElementById("ex-add-btn").onclick = function () {
      let val = document.getElementById("ex-add-input").value.trim();
      if (!val) return;
      if (exData.includes(val)) return exStatus("Tato fr√°ze u≈æ existuje!", true);
      exData.push(val);
      exSaveAll("Fr√°ze p≈ôid√°na.");
      document.getElementById("ex-add-input").value = "";
    };

    // Inline editace, maz√°n√≠, ulo≈æen√≠, cancel, bulk delete
    document.getElementById("ex-table-rows").onclick = function (e) {
      const btn = e.target.closest("button.kw-icon-btn");
      if (!btn) return;
      const idx = parseInt(btn.dataset.i);
      const action = btn.dataset.action;
      if (action === "edit") {
        exEditingIndex = idx; exRenderTable();
        setTimeout(() => { document.getElementById("ex-edit-input").focus(); }, 50);
      }
      if (action === "delete") {
        if (confirm("Opravdu smazat tuto fr√°zi?")) {
          exData.splice(idx, 1);
          exSaveAll("Fr√°ze smaz√°na.");
        }
      }
      if (action === "save") {
        const val = document.getElementById("ex-edit-input").value.trim();
        if (!val) return;
        if (exData.includes(val)) return exStatus("Tato fr√°ze u≈æ existuje!", true);
        exData[idx] = val;
        exEditingIndex = null;
        exSaveAll("Fr√°ze upravena.");
      }
      if (action === "cancel") {
        exEditingIndex = null; exRenderTable();
      }
    };
    // Enter p≈ôi editaci
    document.getElementById("ex-table-rows").addEventListener("keydown", function (e) {
      if (e.target.id === "ex-edit-input" && e.key === "Enter") {
        document.querySelector('#ex-table-rows [data-action="save"]').click();
      }
    });

    // ≈òazen√≠ klikem na z√°hlav√≠
    document.getElementById("ex-sort-th").onclick = function () {
      if (!exSortByCount) {
        exSortAsc = !exSortAsc;
      } else {
        exSortByCount = false;
        exSortAsc = true;
      }
      document.getElementById("ex-sort-arrow").textContent = exSortAsc ? "‚Üë" : "‚Üì";
      document.getElementById("ex-sort-count-arrow").textContent = "";
      exRenderTable();
    };
    // ≈òazen√≠ dle v√Ωskyt≈Ø
    document.getElementById("ex-sort-count-th").onclick = function () {
      if (exSortByCount) {
        exSortAsc = !exSortAsc;
      } else {
        exSortByCount = true;
        exSortAsc = false;
      }
      document.getElementById("ex-sort-count-arrow").textContent = exSortAsc ? "‚Üë" : "‚Üì";
      document.getElementById("ex-sort-arrow").textContent = "";
      exRenderTable();
    };

    // Filtrov√°n√≠
    document.getElementById("ex-filter").oninput = function () {
      exRenderTable();
    };

    // V√Ωbƒõr v≈°ech pro bulk
    document.getElementById("ex-bulk-select").onchange = function () {
      document.querySelectorAll('#ex-table-rows .kw-table-select').forEach(cb => cb.checked = this.checked);
      document.getElementById('ex-bulk-delete-btn').style.display = this.checked ? "" : "none";
    };

    // Bulk maz√°n√≠
    document.getElementById("ex-bulk-delete-btn").onclick = function () {
      if (!confirm("Opravdu smazat vybran√© fr√°ze?")) return;
      let sel = Array.from(document.querySelectorAll('#ex-table-rows .kw-table-select:checked')).map(cb => parseInt(cb.dataset.i));
      exData = exData.filter((_, i) => !sel.includes(i));
      exSaveAll("Fr√°ze smaz√°ny.");
      document.getElementById("ex-bulk-select").checked = false;
    };

    // Ulo≈æit v≈°e do Firebase
    function exSaveAll(msg) {
      fetch(EX_FIREBASE_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(exData)
      }).then(() => { exStatus(msg); exRenderTable(); });
    }

    // INIT po otev≈ôen√≠ modalu
    function exShowModal() {
      document.getElementById("excluded-modal").style.display = "flex";
      exLoadTable();
    }
    document.getElementById("show-excluded-btn").onclick = exShowModal;
    document.getElementById("close-excluded-modal").onclick = () => hideModal("excluded-modal");


    const FIREBASE_URL = "https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/poptavky.json";
    let CURRENT_BRANCH = "poptavky";

    function switchTab(branch) {
      CURRENT_BRANCH = branch;
      const FIREBASE_URL = `https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/${branch}.json`;
      document.getElementById('posts').innerHTML = "Naƒç√≠t√°m...";
      // Nejprve naƒçti skupiny, pak teprve p≈ô√≠spƒõvky:
      fetch(GROUPS_FIREBASE_URL)
        .then(r => r.json())
        .then(arr => {
          groupData = Array.isArray(arr) ? arr : [];
          return fetch(FIREBASE_URL);
        })
        .then(resp => resp.json())
        .then(data => renderPosts(data))
        .catch(() => {
          document.getElementById('posts').innerHTML = '<div style="color:#f55;font-weight:bold">Chyba p≈ôi naƒç√≠t√°n√≠ dat</div>';
        });

    }

    // Aktivace tab≈Ø
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("#postsTab .nav-link").forEach(tab => {
        tab.addEventListener("click", function (e) {
          e.preventDefault();
          document.querySelectorAll("#postsTab .nav-link").forEach(t => t.classList.remove("active"));
          this.classList.add("active");
          switchTab(this.dataset.branch);
        });
      });
    });

    function fetchRunLog() {
      const KEYS = [
        ["started", "Posledn√≠ aktualizace", "<span class='material-icons' title='Posledn√≠ aktualizace'>schedule</span>"],
        ["duration_sec", "Doba [s]", "<span class='material-icons' title='Doba'>timer</span>"],
        ["total", "Zpracov√°no", "<span class='material-icons' title='Zpracov√°no'>done_all</span>"],
        ["saved", "Nov√©", "<span class='material-icons' title='Nov√©'>fiber_new</span>"],
        ["dup", "Duplicit", "<span class='material-icons' title='Duplicit'>content_copy</span>"],
        ["offer", "Nab√≠dky", "<span class='material-icons' title='Nab√≠dky'>local_offer</span>"],
        ["noKey", "Bez kl√≠ƒçe", "<span class='material-icons' title='Bez kl√≠ƒçe'>vpn_key_off</span>"],
        ["noUrl", "Bez URL", "<span class='material-icons' title='Bez URL'>link_off</span>"],
      ];
      fetch("https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/runs.json")
        .then(r => r.json())
        .then(data => {
          if (!data) return;
          let arr = Object.values(data)
            .filter(run => run.started)
            .sort((a, b) => new Date(b.started) - new Date(a.started));
          let run = arr[0];
          if (!run) return;
          let html = `<div>`;
          for (const [key, label, icon] of KEYS) {
            let value = run[key];
            if (key === "started" || key === "finished") {
              value = value ? new Date(value).toLocaleString('cs-CZ') : "";
            }
            if (typeof value === "undefined" || value === null || value === "") continue;
            html += `<span style='display:inline-flex;align-items:center; >
              <span style='opacity:.79;cursor:pointer;' title='${label}'>${icon}</span>
              <span style='font-weight:bold;min-width:2.3em;text-align:right;line-height:1;'>${value}</span>
            </span>`;
          }
          html += `</div>`;
          document.getElementById("run-log").innerHTML = html;
        });
    }
    fetchRunLog();
    setInterval(fetchRunLog, 45000);

    function extractPostDate(text) {
      const months = [
        "ledna", "√∫nora", "b≈ôezna", "dubna", "kvƒõtna", "ƒçervna",
        "ƒçervence", "srpna", "z√°≈ô√≠", "≈ô√≠jna", "listopadu", "prosince"
      ];
      const re = /(\d{1,2})\.\s*(ledna|√∫nora|b≈ôezna|dubna|kvƒõtna|ƒçervna|ƒçervence|srpna|z√°≈ô√≠|≈ô√≠jna|listopadu|prosince)\s+v?e?\s+(\d{1,2}):(\d{2})/i;
      const match = text.match(re);
      if (!match) return null;
      const day = parseInt(match[1]);
      const month = months.indexOf(match[2].toLowerCase());
      const hour = parseInt(match[3]);
      const minute = parseInt(match[4]);
      if (month === -1) return null;
      const year = (new Date()).getFullYear();
      return new Date(year, month, day, hour, minute, 0, 0);
    }

    function extractCleanText(text) {
      // Odstran√≠ "? 22. ƒçervence v 12:32" nebo podobn√Ω zaƒç√°tek, p≈ô√≠padnƒõ i "? "
      return text.replace(/^[?]?\s*\d{1,2}\.\s*(ledna|√∫nora|b≈ôezna|dubna|kvƒõtna|ƒçervna|ƒçervence|srpna|z√°≈ô√≠|≈ô√≠jna|listopadu|prosince)\s+v?e?\s+\d{1,2}:\d{2}\s*/i, '').trim();
    }

    function extractOnlyTime(date) {
      if (!date) return "";
      return date.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' });
    }

    function fetchComments(postId, cb) {
      fetch(`https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`)
        .then(resp => resp.json())
        .then(comments => cb(comments))
        .catch(() => cb(null));
    }

    function addComment(postId, text, cb) {
      const commentObj = {
        text,
        time: new Date().toISOString()
      };
      fetch(`https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/poptavky/${postId}/comments.json`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(commentObj)
      }).then(() => cb && cb());
    }

    switchTab("poptavky");


    function renderPosts(data) {
      const container = document.getElementById('posts');
      if (!data) {
        container.innerHTML = '<div style="color:#999">≈Ω√°dn√© p≈ô√≠spƒõvky...</div>';
        return;
      }
      const timelineColors = [
        '#1976d2', '#e96458', '#27b36a', '#e4a600', '#9562e6'
      ];
      const items = Object.entries(data)
        .map(([id, post]) => ({ ...post, _id: id }))
        .map(post => {
          let dt = extractPostDate(post.text || "");
          post._dateObj = dt;
          post._dateStr = dt
            ? dt.toLocaleDateString('cs-CZ', { year: 'numeric', month: '2-digit', day: '2-digit' })
            : 'Nezn√°m√© datum';
          return post;
        })
        .sort((a, b) => {
          if (!a._dateObj && !b._dateObj) return 0;
          if (!a._dateObj) return 1;
          if (!b._dateObj) return -1;
          return b._dateObj - a._dateObj;
        });

      let days = {};
      for (const post of items) {
        const key = post._dateStr;
        if (!days[key]) days[key] = [];
        days[key].push(post);
      }
      let html = '';
      let colorIdx = 0;

      for (const day of Object.keys(days)) {
        const color = timelineColors[colorIdx % timelineColors.length];

        let timelineHtml = `<div class="timeline" style="--primary:${color};">
      <div class="timeline-line"></div>
      <div class="timeline-dot"></div>
    </div>`;

        let cardsHtml = `<div class="cards-day">    `;
        for (const post of days[day]) {
          let realDate = post._dateObj;
          let showTime = extractOnlyTime(realDate);
          const groupName = (groupData.find(g => g.id === post.groupId) || {}).name || post.groupId || "Nezn√°m√° skupina";
          const group = groupData.find(g => g.id === post.groupId);
          // Paleta, m≈Ø≈æe≈° zmƒõnit nebo roz≈°√≠≈ôit!
          const groupColors = ['#1976d2', '#e96458', '#27b36a', '#e4a600', '#9562e6', '#b88138', '#e04e9f', '#18808b', '#888', '#2196F3', '#FF5722'];
          // Index skupiny v groupData (podle po≈ôad√≠ p≈ôidan√≠)
          const groupIdx = groupData.findIndex(g => g.id === post.groupId);
          const groupColor = groupColors[groupIdx % groupColors.length];
          // Fajfka stav
          const isChecked = !!post.checkedTime;
          const checkedClass = isChecked ? "checked" : "";
          const checkedTimeStr = isChecked
            ? new Date(post.checkedTime).toLocaleString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
            : "";

          cardsHtml += `
      <div class="card" id="post_${post._id}">
        <div class="card-header">
          <div class="card-time">${showTime}</div>
          <span class="material-icons profil" title="Profil">person</span>
          
          ${post.userUrl
              ? `<a href="${post.userUrl}" target="_blank" class="user-link" title="${post.author || "Nezn√°m√Ω"}">${post.author || "Nezn√°m√Ω"}</a>`
              : `<span class="user-link" style="color:#aaa;pointer-events:none;" title="${post.author || "Nezn√°m√Ω"}">${post.author || "Nezn√°m√Ω"}</span>`
            }
          <a href="${post.url}" target="_blank" class="post-link" title="Otev≈ô√≠t p≈ô√≠spƒõvek">
            <span class="material-icons openinnew">open_in_new</span>
          </a>
          
        </div>
        <div class="card-body">${extractCleanText(post.text || "")}</div>
         <div class="chips-box" style="margin-bottom:7px;">
        ${(post.matchedKeyword || post.matchedExcluded) ? `
       
          ${post.matchedKeyword ? `<span class="kw-chip" title="Toto kl√≠ƒçov√© slovo rozhodlo o za≈ôazen√≠">${post.matchedKeyword}</span>` : ""}
          ${post.matchedExcluded ? `<span class="ex-chip" title="Tato fr√°ze rozhodla o za≈ôazen√≠">${post.matchedExcluded}</span>` : ""}
          ${group ? `<span class="material-icons" style="color:${groupColor};" title="${groupName}">groups</span>` : ""}
            <button class="checkmark-btn ${checkedClass}" id="chk_${post._id}" title="${isChecked ? `Oznaƒçeno: ${checkedTimeStr}\nKlikni pro zru≈°en√≠` : 'Oznaƒçit jako vy≈ô√≠zen√©'}">
          <span class="material-icons">done</span>
        </button>
        
        ` : ""}
        </div>
        
      
      </div>
      `;
        }
        cardsHtml += '</div>';

        html += ` <span class="timeline-date    "  style="--primary:${color};--primary-dark:${color};">${day}</span> 
    <div class="day-row" style="--primary:${color};--primary-dark:${color};">
      ${timelineHtml}
      ${cardsHtml}
    </div>
  `;
        colorIdx++;
      }

      container.innerHTML = html;

      // Nastavit funkci na fajfku na v≈°ech kart√°ch
      for (const day of Object.keys(days)) {
        for (const post of days[day]) {
          const btn = document.getElementById(`chk_${post._id}`);
          if (!btn) continue;
          btn.onclick = function () {
            const isNowChecked = !btn.classList.contains('checked');
            let checkedTime = isNowChecked ? new Date().toISOString() : null;

            // Ulo≈æ do Firebase, pou≈æij aktu√°ln√≠ branch!
            fetch(`https://poptavky-59312-default-rtdb.europe-west1.firebasedatabase.app/${CURRENT_BRANCH}/${post._id}/checkedTime.json`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(checkedTime)
            }).then(() => {
              // Po ulo≈æen√≠ refreshni pouze fajfku
              btn.classList.toggle('checked', isNowChecked);
              if (isNowChecked) {
                btn.title = `Oznaƒçeno: ${new Date(checkedTime).toLocaleString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}\nKlikni pro zru≈°en√≠`;
              } else {
                btn.title = "Oznaƒçit jako vy≈ô√≠zen√©";
              }
            });
          }
        }
      }
    }

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // zobrazit tlaƒç√≠tko u≈æivateli:
      const btn = document.createElement('button');
      btn.textContent = 'P≈ôidat aplikaci na plochu';
      btn.className = 'filter-btn';
      btn.onclick = () => {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          btn.remove();
        });
      };
      document.body.appendChild(btn);
    });

  </script>
</body>

</html>
